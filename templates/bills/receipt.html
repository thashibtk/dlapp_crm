{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
  /* --- A4 Print Styles (unified) --- */
  .print-table-container { display: none; }

  @media print {
    @page { size: A4 portrait; margin: 10mm 8mm 15mm 8mm; }

    body { margin:0!important; padding:0!important; font-family: Arial, Helvetica, sans-serif!important;
           font-size:10pt!important; line-height:1.2!important; color:#000!important; background:#fff!important; width:100%!important; }

    /* Hide everything by default */
    body * { visibility: hidden !important; }

    /* Show only the print container and its contents */
    .print-table-container, .print-table-container * { visibility: visible !important; }

    /* Position print container */
    .print-table-container {
      display:block !important; position:absolute !important; left:0 !important; top:0 !important; width:100% !important;
      margin:0 !important; padding:0 !important; background:#fff !important;
    }

    /* Updated Header Layout */
    .print-header {
      display: block !important;
      margin-bottom: 20px;
      border-bottom: 2px solid #333;
      padding-bottom: 15px;
    }
    
    .print-header-top {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .print-header-left { 
      flex: 0 0 auto;
    }
    
    .print-header-center {
      flex: 1;
      text-align: center;
    }
    
    .print-header img { 
      width: 70px; 
      height: auto; 
    }
    
    .print-header h1 {
      font-size: 22px;
      font-weight: bold;
      color: #2b5f60;
      margin: 0 0 8px 0;
    }
    
    .print-header-contact {
      font-size: 11px;
      color: #555;
      margin-bottom: 8px;
    }
    
    .print-header-addresses {
      display: flex !important;
      justify-content: space-between;
      gap: 15px;
      font-size: 10px;
      color: #333;
      line-height: 1.4;
    }
    
    .address-item {
      flex: 1;
      padding: 6px 8px;
      background-color: #f5f5f5 !important;
      border-left: 3px solid #2b5f60 !important;
    }
    
    .address-item strong {
      display: block;
      margin-bottom: 2px;
      color: #2b5f60;
    }

    .print-table { width:100%; border-collapse:collapse; margin-top:20px; }
    .print-table th, .print-table td { border:1px solid #ddd; padding:6px; text-align:left; font-size:11px; }
    .print-table th { background-color:#2b5f60 !important; color:#fff !important; font-weight:bold; }
    .print-table tfoot th, .print-table tfoot td { font-weight:600; }
    .print-note { margin-top: 14px; font-size: 11px; color:#555; }

    .print-table tfoot th {
        background-color: transparent !important;
        color: #000 !important;
    }

    .print-footer { text-align:center; margin-top:32px; font-size:10px; color:#666; }

    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
  }
</style>


<div class="container-fluid default-dashboard">
  <div class="row">

    <!-- Header -->
    <div class="col-md-12 project-list d-print-none">
      <div class="card">
        <div class="row">
          <div class="col-md-6 p-0">
            <ul class="nav nav-tabs border-tab d-flex" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" href="#" role="tab" aria-selected="true">
                  <i class="fa fa-receipt me-1"></i>
                  Bill Receipt • <span class="text-muted">#{{ bill.bill_number }}</span>
                </a>
              </li>
            </ul>
          </div>
          <div class="col-md-6 p-0 d-flex justify-content-end align-items-center gap-2">

            {% if bill.bill_type == 'service' %}
              <a class="btn btn-outline-secondary" href="{% url 'service_bill_list' %}">
                <i class="fa fa-arrow-left me-2"></i>Back to Bills
              </a>
              <a class="btn btn-warning" href="{% url 'service_bill_edit' bill.pk %}">
                <i class="fa fa-pencil me-2"></i>Edit
              </a>
            {% else %}
              <a class="btn btn-outline-secondary" href="{% url 'pharmacy_bill_list' %}">
                <i class="fa fa-arrow-left me-2"></i>Back to Bills
              </a>
              <a class="btn btn-warning" href="{% url 'pharmacy_sale_edit' bill.pk %}">
                <i class="fa fa-pencil me-2"></i>Edit
              </a>
            {% endif %}

            <button class="btn btn-primary" type="button" onclick="printBill()">
              <i class="fa fa-print me-2"></i>Print
            </button>

          </div>
        </div>
      </div>
    </div>

    <!-- Receipt -->
    <div class="col-12">
      <div class="card p-4">
        <!-- Top meta -->
        <div class="d-flex flex-column flex-sm-row justify-content-between gap-2">
          <div>
            <h5 class="mb-0">DLapp Clinic</h5>
            <div class="text-muted">
              Bill / Receipt{% if bill.bill_type %} • {{ bill.get_bill_type_display }}{% endif %}
            </div>
          </div>
          <div class="text-sm-end">
            <div><b>Bill #:</b> {{ bill.bill_number }}</div>
            <div><b>Date:</b> {{ bill.bill_date|date:"Y-m-d H:i" }}</div>
          </div>
        </div>

        <hr>

        <!-- Parties -->
        <div class="row g-3">
          <div class="col-md-6">
            <div class="small text-muted fw-semibold mb-1">
              <i class="fa fa-user me-1"></i>Patient
            </div>
            <div class="fw-semibold">{{ bill.patient.name }}</div>
            <div class="text-muted">{{ bill.patient.phone_number }}</div>
            {% if bill.patient.city %}
              <div class="text-muted">{{ bill.patient.city }}</div>
            {% endif %}
          </div>
          <div class="col-md-6 text-md-end">
            <div class="small text-muted fw-semibold mb-1">
              <i class="fa fa-info-circle me-1"></i>Summary
            </div>
            <div><b>Subtotal:</b> ₹ {{ subtotal|floatformat:2 }}</div>
            <div><b>Tax:</b> ₹ {{ bill.tax_amount|floatformat:2 }}</div>
            <div><b>Discount:</b> ₹ {{ bill.discount_amount|floatformat:2 }}</div>
            <div class="h6 mb-0 mt-2"><b>Total:</b> ₹ {{ bill.total_amount|floatformat:2 }}</div>
          </div>
        </div>

        <!-- Items -->
        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:60px">#</th>
                <th>Description</th>
                <th class="text-end" style="width:120px">Qty</th>
                <th class="text-end" style="width:140px">Unit ₹</th>
                <th class="text-end" style="width:160px">Line Total ₹</th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ it.description|default:"—" }}</td>
                <td class="text-end">{{ it.quantity }}</td>
                <td class="text-end">{{ it.unit_price|floatformat:2 }}</td>
                <td class="text-end">{{ it.total_price|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted py-4">No items.</td></tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="4" class="text-end">Subtotal</th>
                <th class="text-end">₹ {{ subtotal|floatformat:2 }}</th>
              </tr>
              <tr>
                <th colspan="4" class="text-end">Tax</th>
                <th class="text-end">₹ {{ bill.tax_amount|floatformat:2 }}</th>
              </tr>
              <tr>
                <th colspan="4" class="text-end">Discount</th>
                <th class="text-end">₹ {{ bill.discount_amount|floatformat:2 }}</th>
              </tr>
              <tr class="table-light">
                <th colspan="4" class="text-end h6 mb-0">Grand Total</th>
                <th class="text-end h6 mb-0">₹ {{ bill.total_amount|floatformat:2 }}</th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="col-md-12 mt-2">
          <div><b>Remaks</b> {{ bill.remark }}</div>
        </div>

        <!-- Payment + Status -->
        <div class="row g-3 mt-4">
          <div class="col-md-6">
            <h6 class="text-muted mb-2"><i class="fa fa-money me-1"></i>Payment</h6>
            <div><b>Paid:</b> ₹ {{ paid|floatformat:2 }}</div>
            <div><b>Method:</b> {{ method_display|default:"—" }}</div>
          </div>
          <div class="col-md-6 text-md-end">
            <h6 class="text-muted mb-2"><i class="fa fa-balance-scale me-1"></i>Status</h6>
            <div><b>Bill status:</b> {{ bill_status }}</div>
            <div><b>Due for this bill:</b>
              {% if balance_for_this_bill > 0 %}
                ₹ {{ balance_for_this_bill|floatformat:2 }}
              {% else %}
                ₹ 0.00
              {% endif %}
            </div>
            <div class="mt-2">
              <b>Patient overall:</b>
              {% if patient_balance > 0 %}
                <span class="badge bg-warning-subtle text-warning border border-warning">Due ₹ {{ patient_balance|floatformat:2 }}</span>
              {% elif patient_balance < 0 %}
                <span class="badge bg-success-subtle text-success border border-success">Advance ₹ {{ patient_balance|floatformat:2|slice:"1:" }}</span>
              {% else %}
                <span class="badge bg-secondary">Settled</span>
              {% endif %}
            </div>
          </div>
        </div>

        <hr class="mt-4">

      </div>
    </div>

  </div>
</div>


<div class="print-table-container" id="printBillWrap">
  <div class="print-header">
    <div class="print-header-top">
      <div class="print-header-left">
        <img src="{% static 'assets/images/logo/dlapp_logo_grncut.png' %}" alt="DLapp">
      </div>
      <div class="print-header-center">
        <h1>D Lapp Hair Regenerative Clinic</h1>
        <div class="print-header-contact">
          Phone: +91 8593957885 | +91 9845337296 | Email: info@dlapphairclinic.com
        </div>
      </div>
    </div>
    
    <div class="print-header-addresses">
      <div class="address-item">
        <strong>Calicut - Malaparamba</strong>
        Kottayil Arcade, Malaparamba<br>
        Calicut-673009
      </div>
      <div class="address-item">
        <strong>Calicut - Kotooli</strong>
        Breeze Building, Netaji Nagar<br>
        Kotooli, Kozhikode-673016
      </div>
      <div class="address-item">
        <strong>Kochi - Kadavanthra</strong>
        RWA-N-16, Cherupushpam Lane 1<br>
        Kadavanthra, Kochi, 682020
      </div>
    </div>
  </div>

  <!-- Bill heading / meta -->
  <div style="display:flex;justify-content:space-between;gap:16px;margin-top:20px;">
    <div>
      <div style="font-size:18px;font-weight:700;margin:0 0 2px;">
        Bill / Receipt{% if bill.bill_type %} • {{ bill.get_bill_type_display }}{% endif %}
      </div>
      <div style="color:#555;">DLapp Clinic</div>
    </div>
    <div style="text-align:right;">
      <div><b>Bill #:</b> {{ bill.bill_number }}</div>
      <div><b>Date:</b> {{ bill.bill_date|date:"Y-m-d H:i" }}</div>
    </div>
  </div>

  <!-- Parties / Summary -->
  <table class="print-table" style="margin-top:14px;">
    <thead>
      <tr>
        <th style="width:55%;">Patient</th>
        <th style="width:45%;">Summary</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <div><b>{{ bill.patient.name }}</b></div>
          <div style="color:#555;">{{ bill.patient.phone_number|default:"—" }}</div>
          {% if bill.patient.city %}
          <div style="color:#555;">{{ bill.patient.city }}</div>
          {% endif %}
        </td>
        <td>
          <div><b>Subtotal:</b> ₹ {{ subtotal|floatformat:2 }}</div>
          <div><b>Tax:</b> ₹ {{ bill.tax_amount|floatformat:2 }}</div>
          <div><b>Discount:</b> ₹ {{ bill.discount_amount|floatformat:2 }}</div>
          <div style="margin-top:6px;font-size:12px;"><b>Total:</b> ₹ {{ bill.total_amount|floatformat:2 }}</div>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Items -->
  <table class="print-table">
    <thead>
      <tr>
        <th style="width:6%;">#</th>
        <th>Description</th>
        <th style="width:12%; text-align:right;">Qty</th>
        <th style="width:14%; text-align:right;">Unit ₹</th>
        <th style="width:16%; text-align:right;">Line Total ₹</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ it.description|default:"—" }}</td>
        <td style="text-align:right;">{{ it.quantity }}</td>
        <td style="text-align:right;">{{ it.unit_price|floatformat:2 }}</td>
        <td style="text-align:right;">{{ it.total_price|floatformat:2 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="5" style="text-align:center; color:#666;">No items.</td></tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="4" style="text-align:right;">Subtotal</th>
        <td style="text-align:right;">₹ {{ subtotal|floatformat:2 }}</td>
      </tr>
      <tr>
        <th colspan="4" style="text-align:right;">Tax</th>
        <td style="text-align:right;">₹ {{ bill.tax_amount|floatformat:2 }}</td>
      </tr>
      <tr>
        <th colspan="4" style="text-align:right;">Discount</th>
        <td style="text-align:right;">₹ {{ bill.discount_amount|floatformat:2 }}</td>
      </tr>
      <tr>
        <th colspan="4" style="text-align:right;">Grand Total</th>
        <td style="text-align:right;">₹ {{ bill.total_amount|floatformat:2 }}</td>
      </tr>
    </tfoot>
  </table>

  <!-- Payment & Status -->
  <table class="print-table" style="margin-top:14px;">
    <thead>
      <tr>
        <th style="width:50%;">Payment</th>
        <th style="width:50%;">Status</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <div><b>Paid:</b> ₹ {{ paid|floatformat:2 }}</div>
          <div><b>Method:</b> {{ method_display|default:"—" }}</div>
        </td>
        <td>
          <div><b>Bill status:</b> {{ bill_status }}</div>
          <div><b>Due for this bill:</b>
            {% if balance_for_this_bill > 0 %}
              ₹ {{ balance_for_this_bill|floatformat:2 }}
            {% else %}
              ₹ 0.00
            {% endif %}
          </div>
          <div style="margin-top:6px;">
            <b>Patient overall:</b>
            {% if patient_balance > 0 %}
              Due ₹ {{ patient_balance|floatformat:2 }}
            {% elif patient_balance < 0 %}
              Advance ₹ {{ patient_balance|floatformat:2|slice:"1:" }}
            {% else %}
              Settled
            {% endif %}
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="print-footer">
    Generated by {{ request.user.get_full_name|default:request.user.username }} on {% now "F d, Y, h:i A" %}
  </div>
</div>


<style>
  @media print {
    .d-print-none { display: none !important; }
    .card { box-shadow: none !important; border: none !important; }
    .table th, .table td { padding: .4rem .5rem !important; }
  }
  .bg-warning-subtle{background:#fff3cd !important}
  .bg-success-subtle{background:#d1e7dd !important}
</style>

<script>
  (function(){
    try {
      const p = new URLSearchParams(window.location.search);
      if (p.get('print') === '1') window.print();
    } catch(e) {}
  })();
</script>

<script>
  function printBill(){ window.print(); }

  // keep your auto-print via ?print=1
  (function(){
    try {
      const p = new URLSearchParams(window.location.search);
      if (p.get('print') === '1') window.print();
    } catch(e) {}
  })();
</script>


{% endblock %}
