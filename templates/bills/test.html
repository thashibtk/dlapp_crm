
{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
  /* Same styles as service_bill for consistent UI */
  .search-dropdown{position:absolute;top:100%;left:0;right:0;border:1px solid #ddd;border-radius:4px;box-shadow:0 4px 6px rgba(0,0,0,.1);z-index:1050;max-height:300px;overflow-y:auto;display:none}
  .search-input{padding:8px;border-bottom:1px solid #eee;}
  .search-results{max-height:250px;overflow-y:auto}
  .search-result-item{padding:10px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer}
  .search-result-item:hover{background:#f8f9fa;color:#000}
  .search-result-item.selected{background:#eef5ff}
  .search-result-item:last-child{border-bottom:none}
  .no-results{padding:15px;text-align:center;color:#666;font-style:italic}
  .bg-warning-subtle{background:#fff3cd !important}
  .bg-success-subtle{background:#d1e7dd !important}
</style>

<div class="container-fluid default-dashboard">
  <div class="row">
    <div class="col-12 project-list">
      <div class="card">
        <div class="row">
          <div class="col-6 p-0">
            <ul class="nav nav-tabs border-tab d-flex" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" href="#" role="tab" aria-selected="true">
                  <i class="fa fa-medkit me-1"></i>
                  {% if is_edit %} Edit {% else %} New {% endif %} Pharmacy Sale
                </a>
              </li>
              <li class="nav-item">
                <span class="text-muted small"><i class="fa fa-tag me-1"></i>Type: Pharmacy</span>
              </li>
            </ul>
          </div>
          <div class="col-6 p-0 d-flex justify-content-end align-items-center">
            <a class="btn btn-outline-secondary" href="{% url 'pharmacy_bill_list' %}">
              <i class="fa fa-arrow-left me-2"></i>Back to Sales
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-12">
      <form method="post" novalidate class="d-print-none">
        {% csrf_token %}
        {% if header_form.non_field_errors %}
          <div class="alert alert-danger">{{ header_form.non_field_errors }}</div>
        {% endif %}

        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="text-muted mb-3"><i class="fa fa-user me-1"></i>Sale Details</h6>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="{{ header_form.patient.id_for_label }}">Patient</label>
                <div class="position-relative">
                  <select name="{{ header_form.patient.html_name }}"
                          id="{{ header_form.patient.id_for_label }}"
                          class="form-select patient-select">
                    <option value="">---------</option>
                    {% for p in header_form.fields.patient.queryset %}
                      <option value="{{ p.pk }}"
                              data-balance="{{ p.balance }}"
                              data-search="{{ p.name }} {{ p.phone_number }} {{ p.file_number }}"
                              {% if header_form.initial.patient == p.pk %}selected{% endif %}>
                        {{ p.name }}
                      </option>
                    {% endfor %}
                  </select>
                  <div class="search-dropdown bg-light text-dark"></div>
                </div>
                <div id="bill-balance-summary" class="mt-2"></div>
                {% if header_form.patient.errors %}
                  <div class="invalid-feedback d-block">{{ header_form.patient.errors|join:", " }}</div>
                {% endif %}
              </div>
            </div>

            <hr class="my-4">

            <h6 class="text-muted mb-3 d-flex align-items-center gap-2">
              <i class="fa fa-medkit me-1"></i>Products
              <button type="button" id="add-row" class="btn btn-sm btn-outline-primary ms-auto">
                <i class="fa fa-plus me-1"></i>Add Row
              </button>
            </h6>

            {{ formset.management_form }}
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th style="min-width: 240px; font-weight:bold;">Product</th>
                    <th style="width: 100px; font-weight:bold;">Qty</th>
                    <th style="width: 150px; font-weight:bold;">Unit Price</th>
                    <th style="width: 140px; font-weight:bold;" class="text-end">Line Total</th>
                    <th style="width: 120px; font-weight:bold;" class="text-center">Remove</th>
                  </tr>
                </thead>
                <tbody id="items-body">
                  {% for f in formset.forms %}
                    <tr class="item-row">
                      {{ f.id }}
                      <td>
                        <div class="position-relative">
                          <select name="{{ f.product.html_name }}" class="form-select product-select" id="{{ f.product.id_for_label }}">
                            <option value="">---------</option>
                            {% for p in f.fields.product.queryset %}
                              <option value="{{ p.pk }}"
                                      data-price="{{ p.default_sale_price|default_if_none:'0.00' }}"
                                      data-search="{{ p.name }} {{ p.sku }}"
                                      data-stock="{{ p.stock }}"
                                      {% if f.initial.product == p.pk %}selected{% endif %}>
                                {{ p.name }}
                              </option>
                            {% endfor %}
                          </select>
                          <div class="search-dropdown bg-light text-dark"></div>
                        </div>
                        <div class="form-text small stock-hint"></div>
                        {% if f.product.errors %}
                          <div class="invalid-feedback d-block">{{ f.product.errors|join:", " }}</div>
                        {% endif %}
                      </td>
                      <td>
                        {{ f.quantity }}
                        {% if f.quantity.errors %}<div class="invalid-feedback d-block">{{ f.quantity.errors|join:", " }}</div>{% endif %}
                      </td>
                      <td>
                        {{ f.unit_price }}
                        {% if f.unit_price.errors %}<div class="invalid-feedback d-block">{{ f.unit_price.errors|join:", " }}</div>{% endif %}
                      </td>
                      <td class="text-end fw-semibold"><span class="line-total">₹ 0.00</span></td>
                      <td class="text-center">
                        {% if f.DELETE %}{{ f.DELETE.as_hidden }}{% endif %}
                        <button type="button" class="btn btn-sm btn-outline-danger remove-row" title="Remove row">
                          <i class="fa fa-times"></i>
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="text-end">Subtotal</th>
                    <th class="text-end"><span id="subtotal">₹ 0.00</span></th>
                    <th></th>
                  </tr>
                  <tr>
                    <th colspan="3" class="text-end">Tax</th>
                    <th class="text-end">
                      {{ header_form.tax_amount }}
                    </th>
                    <th></th>
                  </tr>
                  <tr>
                    <th colspan="3" class="text-end">Discount</th>
                    <th class="text-end">
                      {{ header_form.discount_amount }}
                    </th>
                    <th></th>
                  </tr>

                  <tr class="table-light">
                    <th colspan="3" class="text-end h6 mb-0 fw-bold">Grand Total</th>
                    <th class="text-end h6 mb-0"><span id="grandtotal">₹ 0.00</span></th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>

              <div class="col-md-12 mt-2">
                <label class="form-label">Remarks</label>
                {{ header_form.remark }}
              </div>
            </div>

            <hr class="my-4">

            <h6 class="text-muted mb-3"><i class="fa fa-money me-1"></i>Payment</h6>
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label d-block">Patient Balance</label>
                <div id="patient-balance" class="fw-semibold text-primary">₹ 0.00</div>
              </div>

              <div class="col-md-3">
                <label class="form-label" for="{{ header_form.paid_amount.id_for_label }}">Amount Paid</label>
                {{ header_form.paid_amount }}
                <div class="form-text">
                  <label class="d-inline-flex align-items-center gap-2">
                    <input type="checkbox" id="pay_full" class="form-check-input" checked>
                    Mark fully paid
                  </label>
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label" for="{{ header_form.payment_method.id_for_label }}">Method</label>
                {{ header_form.payment_method }}
              </div>
            </div>
          </div>

          <div class="card-footer d-flex justify-content-end gap-2">
            {% if is_edit %}
              <a class="btn btn-light" href="{% url 'sale_receipt' sale.pk %}"><i class="fa fa-ban me-1"></i>Cancel</a>
            {% else %}
              <a class="btn btn-light" href="{% url 'pharmacy_bill_list' %}"><i class="fa fa-ban me-1"></i>Cancel</a>
            {% endif %}
            <button class="btn btn-primary"><i class="fa fa-save me-1"></i>Save Sale</button>
          </div>
        </div>
      </form>
    </div>

    <div class="col-md-12">
      <div id="previous-sales" class="mt-4 d-print-none"></div>
    </div>
  </div>
</div>

<template id="empty-form-template">
  <tr class="item-row">
    {{ formset.empty_form.id }}
    <td>
      <div class="position-relative">
        <select name="{{ formset.empty_form.product.html_name }}" class="form-select product-select" id="{{ formset.empty_form.product.id_for_label }}">
          <option value="">---------</option>
          {% for p in formset.empty_form.fields.product.queryset %}
            <option value="{{ p.pk }}"
                    data-price="{{ p.default_sale_price|default_if_none:'0.00' }}"
                    data-search="{{ p.name }} {{ p.sku }}"
                    data-stock="{{ p.stock }}">
              {{ p.name }}
            </option>
          {% endfor %}
        </select>
        <div class="search-dropdown bg-light text-dark"></div>
      </div>
      <div class="form-text small stock-hint"></div>
    </td>
    <td>{{ formset.empty_form.quantity }}</td>
    <td>{{ formset.empty_form.unit_price }}<div class="form-text small">Auto-filled & read-only</div></td>
    <td class="text-end fw-semibold"><span class="line-total">₹ 0.00</span></td>
    <td class="text-center">
      {% if formset.empty_form.DELETE %}{{ formset.empty_form.DELETE.as_hidden }}{% endif %}
      <button type="button" class="btn btn-sm btn-outline-danger remove-row" title="Remove row"><i class="fa fa-times"></i></button>
    </td>
  </tr>
</template>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const tbody = document.getElementById('items-body');
  const tmpl = document.getElementById('empty-form-template').innerHTML;
  const totalForms = document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS');
  const taxInput = document.getElementById('{{ header_form.tax_amount.id_for_label }}') || document.querySelector('[name="{{ header_form.tax_amount.html_name }}"]');
  const discInput = document.getElementById('{{ header_form.discount_amount.id_for_label }}') || document.querySelector('[name="{{ header_form.discount_amount.html_name }}"]');

  const payAmount = document.getElementById('{{ header_form.paid_amount.id_for_label }}');
  const payMethod = document.getElementById('{{ header_form.payment_method.id_for_label }}');
  const payFull = document.getElementById('pay_full');
  
  const patientSel = document.querySelector('.patient-select');
  const patientBalEl = document.getElementById('patient-balance');
  const billBalanceSummaryEl = document.getElementById('bill-balance-summary');
  
  let patientBalance = 0; // +ve = due, -ve = advance
  let payDirty = false;

  function toNum(v){ return parseFloat(String(v??'').replace(/,/g,'')) || 0; }
  function fmt(n){ return '₹ ' + (isFinite(n)? Number(n) : 0).toFixed(2); }

  // Searchable select functionality (Same as service_bill)
  function makeSearchableSelect(select, options = {}) {
    if (!select) return;

    const wrapper = select.parentElement;
    const dropdown = wrapper.querySelector('.search-dropdown');
    if (!dropdown) return;

    let isOpen = false;
    let allOptions = Array.from(select.options).slice(1);
    let filteredOptions = [...allOptions];
    let selectedIndex = -1;

    function showDropdown() {
      if (isOpen) return;
      isOpen = true;
      dropdown.style.display = 'block';
      dropdown.innerHTML = `
        <div class="search-input">
          <input type="text" class="form-control form-control-sm" placeholder="${options.placeholder || 'Search...'}" autocomplete="off">
        </div>
        <div class="search-results"></div>
      `;
      
      const searchInput = dropdown.querySelector('input');
      const resultsDiv = dropdown.querySelector('.search-results');
      
      searchInput.focus();
      renderResults();

      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        filteredOptions = allOptions.filter(opt => {
          const searchText = opt.getAttribute('data-search') || opt.textContent;
          return searchText.toLowerCase().includes(query);
        });
        selectedIndex = -1;
        renderResults();
      });

      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, filteredOptions.length - 1);
          updateSelection();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelection();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && filteredOptions[selectedIndex]) {
            selectOption(filteredOptions[selectedIndex]);
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      function renderResults() {
        if (filteredOptions.length === 0) {
          resultsDiv.innerHTML = '<div class="no-results">No results found</div>';
        } else {
          resultsDiv.innerHTML = filteredOptions.map((opt, idx) => 
            `<div class="search-result-item" data-value="${opt.value}">${opt.textContent}</div>`
          ).join('');
        }
        updateSelection();
      }

      function updateSelection() {
        resultsDiv.querySelectorAll('.search-result-item').forEach((item, idx) => {
          item.classList.toggle('selected', idx === selectedIndex);
        });
      }

      resultsDiv.addEventListener('click', function(e) {
        const item = e.target.closest('.search-result-item');
        if (item) {
          const option = allOptions.find(opt => opt.value === item.getAttribute('data-value'));
          if (option) selectOption(option);
        }
      });
    }

    function hideDropdown() {
      isOpen = false;
      dropdown.style.display = 'none';
      selectedIndex = -1;
    }

    function selectOption(option) {
      select.value = option.value;
      select.dispatchEvent(new Event('change'));
      hideDropdown();
    }

    select.addEventListener('mousedown', function(e) {
      e.preventDefault();
      showDropdown();
    });

    select.addEventListener('focus', showDropdown);

    document.addEventListener('click', function(e) {
      if (!wrapper.contains(e.target)) {
        hideDropdown();
      }
    });
  }


  // Balance labels (Same as service_bill)
  function setBalanceLabels() {
    const labelText = patientBalance < 0
      ? `Advance ${fmt(Math.abs(patientBalance)).replace('₹ ', '₹ ')}`
      : `Due ${fmt(patientBalance)}`;
    if (patientBalEl) patientBalEl.textContent = labelText;
    if (billBalanceSummaryEl) billBalanceSummaryEl.innerHTML =
      `<span class="badge ${patientBalance<0?'bg-success-subtle text-success border border-success':'bg-warning-subtle text-warning border border-warning'}">
        <i class="fa ${patientBalance<0?'fa-level-up':'fa-level-down'} me-1"></i>${labelText}
      </span>`;
  }

  async function updatePatientBalance() {
    const opt = patientSel?.options[patientSel.selectedIndex];
    if (!opt || !opt.value){
      patientBalance = 0; setBalanceLabels(); return;
    }
    
    try {
      const res = await fetch(`/api/patients/${opt.value}/balance/`);
      const data = await res.json();
      patientBalance = parseFloat(data.balance || '0') || 0;
    } catch(_) {
      patientBalance = parseFloat(opt.dataset.balance || '0') || 0;
    }
    setBalanceLabels();
  }

  // Row binding
  function bindRow(row){
    row.querySelectorAll('select').forEach(s=>s.classList.add('form-select'));
    row.querySelectorAll('input[type="number"],input[type="text"]').forEach(i=>i.classList.add('form-control'));

    const qty = row.querySelector('input[name$="-quantity"]');
    const unit = row.querySelector('input[name$="-unit_price"]');
    const delField = row.querySelector('input[name$="-DELETE"]');
    const rmBtn = row.querySelector('.remove-row');
    const lineLbl = row.querySelector('.line-total');
    const productSel = row.querySelector('select[name$="-product"]');
    const stockHint = row.querySelector('.stock-hint');

    // --- helpers ---
    const getPriceFromOption = (opt) => {
      if (!opt) return 0;
      const raw = opt.dataset.price ?? opt.getAttribute('data-price') ?? '0';
      const p = parseFloat(raw);
      return isNaN(p) ? 0 : p;
    };
    
    const getStockFromOption = (opt) => {
      if (!opt) return 0;
      const raw = opt.dataset.stock ?? opt.getAttribute('data-stock') ?? '0';
      const s = parseInt(raw);
      return isNaN(s) ? 0 : s;
    }

    const recalcLine = () => {
      const q = Math.max(0, toNum(qty?.value));
      const u = toNum(unit?.value);
      if (lineLbl) lineLbl.textContent = fmt(q * u);
      recalcTotals();
    };

    const applyDefaultPrice = (force=false) => {
      if (!productSel || !unit) return;
      const price = getPriceFromOption(productSel.selectedOptions?.[0]);
      const current = toNum(unit.value);
      if (force || !unit.value || current === 0) {
        unit.value = price.toFixed(2);
      }
      if (qty && (!qty.value || toNum(qty.value) <= 0)) qty.value = 1;
      recalcLine();
    };
    
    const updateStockHint = () => {
      if (!productSel || !stockHint) return;
      const stock = getStockFromOption(productSel.selectedOptions?.[0]);
      if (stock > 0) {
        stockHint.textContent = `In stock: ${stock}`;
        stockHint.style.color = 'green';
      } else {
        stockHint.textContent = 'Out of stock!';
        stockHint.style.color = 'red';
      }
    };

    // --- lock unit price ---
    if (unit) {
      unit.readOnly = true;
      unit.setAttribute('readonly', 'readonly');
      unit.classList.add('bg-light');
      unit.setAttribute('inputmode','decimal');
    }

    // --- events ---
    productSel?.addEventListener('change', () => {
      applyDefaultPrice(true);
      updateStockHint();
    });
    qty?.addEventListener('input', recalcLine);

    applyDefaultPrice(false);
    updateStockHint();

    // Remove row
    rmBtn?.addEventListener('click', (e)=>{
      e.preventDefault();
      const idField = row.querySelector('input[name$="-id"]');
      if (delField && idField && idField.value){
        delField.checked = true;
        row.style.display = 'none';
      } else {
        row.remove();
        if (typeof totalForms !== 'undefined' && totalForms) {
          totalForms.value = String(Math.max(0, (parseInt(totalForms.value||'0') - 1)));
        }
      }
      recalcTotals();
    });

    // Make product select searchable
    makeSearchableSelect(productSel, { placeholder: 'Search products...' });
  }


  function addRow(){
    const idx = parseInt(totalForms.value||'0');
    const html = tmpl.replace(/__prefix__/g, idx);
    const frag = document.createElement('tbody');
    frag.innerHTML = html.trim();
    const row = frag.firstElementChild;
    tbody.appendChild(row);
    totalForms.value = String(idx+1);
    bindRow(row);
  }

  function recalcTotals(){
    let subtotal = 0;
    tbody.querySelectorAll('.item-row').forEach(row=>{
      if (row.style.display==='none') return;
      const del = row.querySelector('input[name$="-DELETE"]');
      if (del && del.checked) return;
      const q = toNum(row.querySelector('input[name$="-quantity"]')?.value);
      const u = toNum(row.querySelector('input[name$="-unit_price"]')?.value);
      subtotal += q*u;
    });
    
    const tax = toNum(taxInput?.value);
    const disc = toNum(discInput?.value);
    const grand = subtotal + tax - disc;

    document.getElementById('subtotal').textContent = fmt(subtotal);
    document.getElementById('grandtotal').textContent = fmt(grand);

    const toPay = grand + patientBalance; // This logic assumes previous due is always added
    
    // Payment auto-fill/lock for "Mark fully paid" checkbox
    if (payFull && payAmount){
      if (payFull.checked){
        if (!payDirty) payAmount.value = toPay.toFixed(2);
        payAmount.readOnly = true;
        payAmount.classList.add('bg-light');
      } else {
        payAmount.readOnly = false;
        payAmount.classList.remove('bg-light');
      }
    }

    // Method required if paying > 0
    if (payMethod && payAmount){
      const paying = toNum(payAmount.value) > 0;
      payMethod.required = paying;
    }
  }

  // Initialize existing rows
  tbody.querySelectorAll('.item-row').forEach(bindRow);

  // Make patient select searchable
  makeSearchableSelect(patientSel, { placeholder: 'Search patients...' });

  // Add row button
  document.getElementById('add-row')?.addEventListener('click', function(e){
    e.preventDefault();
    addRow();
  });

  // Event listeners for calculations
  taxInput && taxInput.addEventListener('input', recalcTotals);
  discInput && discInput.addEventListener('input', recalcTotals);

  // Payment handling
  if (payFull){
    payFull.addEventListener('change', ()=>{
      payDirty = false;
      recalcTotals();
    });
  }
  if (payAmount){
    payAmount.addEventListener('input', ()=>{ payDirty = true; });
    payAmount.addEventListener('focus', ()=>{ payDirty = true; });
  }

  // Patient selection handling
  if (patientSel){
    patientSel.addEventListener('change', async ()=>{
      payDirty = false;
      await updatePatientBalance();
      recalcTotals();
    });
    updatePatientBalance().then(()=>{ recalcTotals(); });
  } else {
    recalcTotals();
  }
});
</script>

{% endblock %}