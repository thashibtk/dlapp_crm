{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DLapp Clinic - Bill #{{ bill.bill_number }}</title>
  <style>
/* --- General Styles --- */
body { font-family: Arial, Helvetica, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
.container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border: 1px solid #ddd; }
.header { text-align: center; }
.header img { width: 80px; }
.header h2 { margin: 5px 0; color: #2b5f60; }
.header p { margin: 2px 0; color: #555; font-size: 12px; }
.info { display: flex; justify-content: space-between; margin-top: 20px; }
.info div { line-height: 1.5; }
.table { width: 100%; border-collapse: collapse; margin-top: 15px; }
.table th, .table td { border: 1px solid #ddd; padding: 6px; }
.table th { background: #2b5f60; color: #fff; }
.text-right { text-align: right; }
.btn-container { margin-top: 20px; text-align: center; }
.btn-container button { padding: 8px 15px; background: #2b5f60; color: #fff; border: none; cursor: pointer; }
</style>

<style>
  /* --- A4 Print Styles (unified) --- */
  .print-table-container { display: none; }

  @media print {
    @page { size: A4 portrait; margin: 10mm 8mm 15mm 8mm; }

    body { margin:0!important; padding:0!important; font-family: Arial, Helvetica, sans-serif!important;
           font-size:10pt!important; line-height:1.2!important; color:#000!important; background:#fff!important; width:100%!important; }

    /* Hide everything by default */
    body * { visibility: hidden !important; }

    /* Show only the print container and its contents */
    .print-table-container, .print-table-container * { visibility: visible !important; }

    /* Position print container */
    .print-table-container {
      display:block !important; position:absolute !important; left:0 !important; top:0 !important; width:100% !important;
      margin:0 !important; padding:0 !important; background:#fff !important;
    }

    /* Updated Header Layout */
    .print-header {
      display: block !important;
      margin-bottom: 20px;
      border-bottom: 2px solid #333;
      padding-bottom: 15px;
    }
    
    .print-header-top {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .print-header-left { 
      flex: 0 0 auto;
    }
    
    .print-header-center {
      flex: 1;
      text-align: center;
    }
    
    .print-header img { 
      width: 70px; 
      height: auto; 
    }
    
    .print-header h1 {
      font-size: 22px;
      font-weight: bold;
      color: #2b5f60;
      margin: 0 0 8px 0;
    }
    
    .print-header-contact {
      font-size: 11px;
      color: #555;
      margin-bottom: 8px;
    }
    
    .print-header-addresses {
      display: flex !important;
      justify-content: space-between;
      gap: 15px;
      font-size: 10px;
      color: #333;
      line-height: 1.4;
    }
    
    .address-item {
      flex: 1;
      padding: 6px 8px;
      background-color: #f5f5f5 !important;
      border-left: 3px solid #2b5f60 !important;
    }
    
    .address-item strong {
      display: block;
      margin-bottom: 2px;
      color: #2b5f60;
    }

    .print-table { width:100%; border-collapse:collapse; margin-top:20px; }
    .print-table th, .print-table td { border:1px solid #ddd; padding:6px; text-align:left; font-size:11px; }
    .print-table th { background-color:#2b5f60 !important; color:#fff !important; font-weight:bold; }
    .print-table tfoot th, .print-table tfoot td { font-weight:600; }
    .print-note { margin-top: 14px; font-size: 11px; color:#555; }

    .print-table tfoot th {
        background-color: transparent !important;
        color: #000 !important;
    }

    .print-footer { text-align:center; margin-top:32px; font-size:10px; color:#666; }

    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
  }
</style>

<div class="container" style="max-width:800px; margin:auto; padding:20px; font-family:Arial, Helvetica, sans-serif; background:#fff; border:1px solid #ddd;">
  
  <!-- Header -->
  <div class="header" style="text-align:center; margin-bottom:20px;">
    <img src="{% static 'assets/images/logo/dlapp_logo_grncut.png' %}" alt="DLapp Clinic" style="width:80px; margin-bottom:10px;">
    <h2 style="margin:5px 0; color:#2b5f60;">D Lapp Hair Regenerative Clinic</h2>
    <p style="margin:2px 0; font-size:12px; color:#555;">Phone: +91 8593957885 | Email: info@dlapphairclinic.com</p>

    <!-- Branches -->
    <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:11px; color:#333;">
      <div style="flex:1; padding:6px 8px; border-left:3px solid #2b5f60; background:#f5f5f5; margin-right:5px;">
        <strong>Calicut - Malaparamba</strong><br>
        Kottayil Arcade, Malaparamba<br>
        Calicut-673009
      </div>
      <div style="flex:1; padding:6px 8px; border-left:3px solid #2b5f60; background:#f5f5f5; margin-right:5px;">
        <strong>Calicut - Kotooli</strong><br>
        Breeze Building, Netaji Nagar<br>
        Kotooli, Kozhikode-673016
      </div>
      <div style="flex:1; padding:6px 8px; border-left:3px solid #2b5f60; background:#f5f5f5;">
        <strong>Kochi - Kadavanthra</strong><br>
        RWA-N-16, Cherupushpam Lane 1<br>
        Kadavanthra, Kochi, 682020
      </div>
    </div>
  </div>
  <hr>

  <!-- Bill Info -->
  <div class="info" 
      style="display: flex; justify-content: space-between; align-items: stretch; gap: 20px; margin-top: 20px; font-size: 13px; line-height: 1.6;">

    <!-- Left: Patient Details -->
    <div style="flex: 1; background: #f9f9f9; padding: 12px 16px; border-radius: 6px; border: 1px solid #ddd; display: flex; flex-direction: column; justify-content: center;">
      <h4 style="margin: 0 0 6px 0; font-size: 15px; text-decoration: underline;">Patient Details</h4>
      <div><b>Name:</b> {{ bill.patient.name }}</div>
      <div><b>Phone:</b> {{ bill.patient.phone_number|default:"—" }}</div>
      {% if bill.patient.city %}
      <div><b>City:</b> {{ bill.patient.city }}</div>
      {% endif %}
    </div>

    <!-- Right: Bill Details -->
    <div style="flex: 1; background: #f9f9f9; padding: 12px 16px; border-radius: 6px; border: 1px solid #ddd; display: flex; flex-direction: column; justify-content: center; text-align: right;">
      <h4 style="margin: 0 0 6px 0; font-size: 15px; text-decoration: underline;">Bill Details</h4>
      <div><b>Bill #:</b> {{ bill.bill_number }}</div>
      <div><b>Date:</b> {{ bill.bill_date|date:"Y-m-d H:i" }}</div>
    </div>

  </div>



  <!-- Items Table -->
  <table style="width:100%; border-collapse:collapse; margin-top:15px;">
    <thead>
      <tr>
        <th style="border:1px solid #ddd; padding:6px; background:#2b5f60; color:#fff;">#</th>
        <th style="border:1px solid #ddd; padding:6px; background:#2b5f60; color:#fff;">Description</th>
        <th style="border:1px solid #ddd; padding:6px; background:#2b5f60; color:#fff; text-align:right;">Qty</th>
        <th style="border:1px solid #ddd; padding:6px; background:#2b5f60; color:#fff; text-align:right;">Unit ₹</th>
        <th style="border:1px solid #ddd; padding:6px; background:#2b5f60; color:#fff; text-align:right;">Line Total ₹</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr>
        <td style="border:1px solid #ddd; padding:6px;">{{ forloop.counter }}</td>
        <td style="border:1px solid #ddd; padding:6px;">{{ it.description }}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:right;">{{ it.quantity }}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:right;">{{ it.unit_price|floatformat:2 }}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:right;">{{ it.total_price|floatformat:2 }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" style="text-align:center; color:#666; padding:10px;">No items.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Totals -->
  <div class="text-right" style="margin-top:15px; line-height:1.5;">
    <b>Subtotal:</b> ₹ {{ subtotal|floatformat:2 }}<br>
    <b>Tax:</b> ₹ {{ bill.tax_amount|floatformat:2 }}<br>
    <b>Discount:</b> ₹ {{ bill.discount_amount|floatformat:2 }}<br>
    <b>Grand Total:</b> ₹ {{ bill.total_amount|floatformat:2 }}
  </div>

  <!-- Print Button -->
  <div class="btn-container" style="margin-top:20px; text-align:center;">
    <button onclick="window.print()" style="padding:8px 15px; background:#2b5f60; color:#fff; border:none; cursor:pointer;">Print / Download</button>
  </div>

</div>

<!-- Print Container -->
<div class="print-table-container" id="printBillWrap">
  <div class="print-header">
    <div class="print-header-top">
      <div class="print-header-left">
        <img src="{% static 'assets/images/logo/dlapp_logo_grncut.png' %}" alt="DLapp">
      </div>
      <div class="print-header-center">
        <h1>D Lapp Hair Regenerative Clinic</h1>
        <div class="print-header-contact">
          Phone: +91 8593957885 | +91 9845337296 | Email: info@dlapphairclinic.com
        </div>
      </div>
    </div>
    
    <div class="print-header-addresses">
      <div class="address-item">
        <strong>Calicut - Malaparamba</strong>
        Kottayil Arcade, Malaparamba<br>
        Calicut-673009
      </div>
      <div class="address-item">
        <strong>Calicut - Kotooli</strong>
        Breeze Building, Netaji Nagar<br>
        Kotooli, Kozhikode-673016
      </div>
      <div class="address-item">
        <strong>Kochi - Kadavanthra</strong>
        RWA-N-16, Cherupushpam Lane 1<br>
        Kadavanthra, Kochi, 682020
      </div>
    </div>
  </div>

  <!-- Bill heading / meta -->
  <div style="display:flex;justify-content:space-between;gap:16px;margin-top:20px;">
    <div>
      <div style="font-size:18px;font-weight:700;margin:0 0 2px;">
        Bill / Receipt{% if bill.bill_type %} • {{ bill.get_bill_type_display }}{% endif %}
      </div>
      <div style="color:#555;">DLapp Clinic</div>
    </div>
    <div style="text-align:right;">
      <div><b>Bill #:</b> {{ bill.bill_number }}</div>
      <div><b>Date:</b> {{ bill.bill_date|date:"Y-m-d H:i" }}</div>
    </div>
  </div>

  <!-- Parties / Summary -->
  <table class="print-table" style="margin-top:14px;">
    <thead>
      <tr>
        <th style="width:55%;">Patient</th>
        <th style="width:45%;">Summary</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <div><b>{{ bill.patient.name }}</b></div>
          <div style="color:#555;">{{ bill.patient.phone_number|default:"—" }}</div>
          {% if bill.patient.city %}
          <div style="color:#555;">{{ bill.patient.city }}</div>
          {% endif %}
        </td>
        <td>
          <div><b>Subtotal:</b> ₹ {{ subtotal|floatformat:2 }}</div>
          <div><b>Tax:</b> ₹ {{ bill.tax_amount|floatformat:2 }}</div>
          <div><b>Discount:</b> ₹ {{ bill.discount_amount|floatformat:2 }}</div>
          <div style="margin-top:6px;font-size:12px;"><b>Total:</b> ₹ {{ bill.total_amount|floatformat:2 }}</div>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Items -->
  <table class="print-table">
    <thead>
      <tr>
        <th style="width:6%;">#</th>
        <th>Description</th>
        <th style="width:12%; text-align:right;">Qty</th>
        <th style="width:14%; text-align:right;">Unit ₹</th>
        <th style="width:16%; text-align:right;">Line Total ₹</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ it.description|default:"—" }}</td>
        <td style="text-align:right;">{{ it.quantity }}</td>
        <td style="text-align:right;">{{ it.unit_price|floatformat:2 }}</td>
        <td style="text-align:right;">{{ it.total_price|floatformat:2 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="5" style="text-align:center; color:#666;">No items.</td></tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="4" style="text-align:right;">Subtotal</th>
        <td style="text-align:right;">₹ {{ subtotal|floatformat:2 }}</td>
      </tr>
      <tr>
        <th colspan="4" style="text-align:right;">Tax</th>
        <td style="text-align:right;">₹ {{ bill.tax_amount|floatformat:2 }}</td>
      </tr>
      <tr>
        <th colspan="4" style="text-align:right;">Discount</th>
        <td style="text-align:right;">₹ {{ bill.discount_amount|floatformat:2 }}</td>
      </tr>
      <tr>
        <th colspan="4" style="text-align:right;">Grand Total</th>
        <td style="text-align:right;">₹ {{ bill.total_amount|floatformat:2 }}</td>
      </tr>
    </tfoot>
  </table>

  <!-- Payment & Status -->
  <table class="print-table" style="margin-top:14px;">
    <thead>
      <tr>
        <th style="width:50%;">Payment</th>
        <th style="width:50%;">Status</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <div><b>Paid:</b> ₹ {{ paid|floatformat:2 }}</div>
          <div><b>Method:</b> {{ method_display|default:"—" }}</div>
        </td>
        <td>
          <div><b>Bill status:</b> {{ bill_status }}</div>
          <div><b>Due for this bill:</b>
            {% if balance_for_this_bill > 0 %}
              ₹ {{ balance_for_this_bill|floatformat:2 }}
            {% else %}
              ₹ 0.00
            {% endif %}
          </div>
          <div style="margin-top:6px;">
            <b>Patient overall:</b>
            {% if patient_balance > 0 %}
              Due ₹ {{ patient_balance|floatformat:2 }}
            {% elif patient_balance < 0 %}
              Advance ₹ {{ patient_balance|floatformat:2|slice:"1:" }}
            {% else %}
              Settled
            {% endif %}
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="print-footer">
    Generated on {% now "F d, Y, h:i A" %}
  </div>
</div>


</html>
