{% extends 'base.html' %}
{% block content %}

<style>
  /* Priority badges */
  .badge-priority-low    { background:#e8f5e9; color:#2e7d32; }
  .badge-priority-medium { background:#fff8e1; color:#ef6c00; }
  .badge-priority-high   { background:#ffebee; color:#c62828; }
  .badge-priority-urgent { background:#fdecea; color:#b71c1c; font-weight:600; }

  /* Mono numbers */
  .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

  /* Scroll region */
  .custom-scrollbar { max-height: 70vh; overflow: auto; }

  /* Place the DT search nicely in header row */
  div.dataTables_wrapper div.dataTables_filter {
    position: static; top:auto; right:auto;
    flex: 1 1 auto; min-width: 200px; max-width: 300px;
    margin-left: auto; text-align: right;
  }
  @media (max-width: 767px) {
    div.dataTables_wrapper div.dataTables_filter {
      flex: 1 1 100%; min-width: unset; max-width: unset;
      margin-left: 0; text-align: left; order: -1; padding: 10px 0;
    }
  }
</style>
<style>
@media print {
  
  @page { 
    size: A4 portrait; 
    margin: 10mm 8mm 15mm 8mm; 
  }

  body {
    margin: 0 !important;
    padding: 0 !important;
    font-family: Arial, Helvetica, sans-serif !important;
    font-size: 10pt !important;
    line-height: 1.2 !important;
    color: #000 !important;
    background: #fff !important;
    width: 100% !important;
  }

  body * { visibility: hidden !important; }
  .print-table-container, .print-table-container * { visibility: visible !important; }

  .print-table-container {
    display: block !important;
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    background: #fff !important;
  }

  /* Updated Header */
  .print-header {
    display: block !important;
    margin-bottom: 20px;
    border-bottom: 2px solid #333;
    padding-bottom: 15px;
  }
  
  .print-header-top {
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .print-header-left { flex: 0 0 auto; }
  .print-header-center { flex: 1; text-align: center; }
  .print-header img { width: 70px; height: auto; }
  
  .print-header h1 {
    font-size: 22px; font-weight: bold;
    color: #2b5f60; margin: 0 0 8px 0;
  }
  
  .print-header-contact {
    font-size: 11px; color: #555; margin-bottom: 8px;
  }
  
  .print-header-addresses {
    display: flex !important;
    justify-content: space-between;
    gap: 15px;
    font-size: 10px;
    color: #333;
    line-height: 1.4;
  }
  
  .address-item {
    flex: 1;
    padding: 6px 8px;
    background-color: #f5f5f5 !important;
    border-left: 3px solid #2b5f60 !important;
  }
  
  .address-item strong {
    display: block;
    margin-bottom: 2px;
    color: #2b5f60;
  }

  .print-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  .print-table th, .print-table td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: left;
    font-size: 11px;
  }
  .print-table th {
    background: #2b5f60 !important;
    color: #fff !important;
    font-weight: 700;
  }
  .print-table tbody tr:nth-child(even) {
    background: #f9f9f9 !important;
  }

  .print-footer {
    text-align: center;
    margin-top: 40px;
    font-size: 10px;
    color: #666;
  }

  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
}
</style>

<div class="container-fluid default-dashboard">
  <div class="row">

    <!-- Header -->
    <div class="col-12 project-list d-print-none">
      <div class="card">
        <div class="row align-items-center">
          <div class="col-12 p-2 d-flex flex-wrap justify-content-between align-items-center gap-2">
            
            <!-- Left side: Leads + Total -->
            <ul class="nav nav-tabs border-tab d-flex align-items-center" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" href="#" role="tab" aria-selected="true">
                  <i class="fa fa-user-plus me-2"></i>Leads
                </a>
              </li>
              <li class="nav-item d-flex align-items-center">
                <span class="text-muted small ms-2">
                  <i class="fa fa-database me-1"></i>{{ leads|length }} total
                </span>
              </li>
            </ul>

            <!-- Right side: Buttons -->
            <div class="d-flex align-items-center gap-2">
              <a class="btn btn-primary" href="{% url 'lead_create' %}">
                <i class="fa fa-plus-square me-2"></i>New Lead
              </a>
              <button type="button" class="btn btn-outline-success" onclick="printLeads()">
                <i class="fa fa-print me-2"></i>Print
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>


    <!-- Filters -->
    <div class="col-12 d-print-none">
      <form class="card p-3 mb-3 shadow-sm border-0" method="get" id="filterForm">
        <div class="row g-3">

          <!-- Date Range -->
          <div class="col-12 col-md-6 col-lg-4">
            <label class="form-label small text-muted mb-1">
              <i class="fa fa-calendar me-1"></i>Date range
            </label>
            <div class="row g-2">
              <div class="col-6">
                <input type="date" class="form-control" name="from"
                      value="{{ selected.from|date:'Y-m-d' }}">
              </div>
              <div class="col-6">
                <input type="date" class="form-control" name="to"
                      value="{{ selected.to|date:'Y-m-d' }}">
              </div>
            </div>
            <!-- Quick Range Buttons -->
            <div class="d-flex flex-wrap gap-2 mt-2">
              <button class="btn btn-outline-secondary btn-sm flex-fill" type="button" data-range="today">
                <i class="fa fa-calendar-day me-1"></i>Today
              </button>
              <button class="btn btn-outline-secondary btn-sm flex-fill" type="button" data-range="7d">
                <i class="fa fa-calendar-week me-1"></i>Last 7 days
              </button>
              <button class="btn btn-outline-secondary btn-sm flex-fill" type="button" data-range="month">
                <i class="fa fa-calendar-alt me-1"></i>This Month
              </button>
            </div>
          </div>

          <!-- Search -->
          <div class="col-12 col-sm-6 col-md-4 col-lg-2">
            <label class="form-label small text-muted mb-1">
              <i class="fa fa-search me-1"></i>Search
            </label>
            <input type="text" class="form-control" name="q"
                  placeholder="Name / phone / email"
                  value="{{ selected.q|default:'' }}">
          </div>

          <!-- Source -->
          <div class="col-12 col-sm-6 col-md-4 col-lg-2">
            <label class="form-label small text-muted mb-1">
              <i class="fa fa-bullhorn me-1"></i>Source
            </label>
            <select name="source" class="form-select">
              <option value="">All</option>
              {% for s in sources %}
                <option value="{{ s.id }}"
                  {% if selected.source|default:'' == s.id|stringformat:'s' %}selected{% endif %}>
                  {{ s.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Status -->
          <div class="col-12 col-sm-6 col-md-4 col-lg-2">
            <label class="form-label small text-muted mb-1">
              <i class="fa fa-list me-1"></i>Status
            </label>
            <select name="status" class="form-select">
              <option value="">All</option>
              <option value="open" {% if selected.status == 'open' %}selected{% endif %}>Open</option>
              <option value="converted" {% if selected.status == 'converted' %}selected{% endif %}>Converted</option>
            </select>
          </div>

          <!-- Action Buttons -->
          <div class="col-12 col-sm-6 col-md-4 col-lg-2">
            <label class="form-label d-none d-md-block mb-1">&nbsp;</label>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-primary flex-fill" type="submit">
                <i class="fa fa-filter me-1"></i>Filter
              </button>
              <a class="btn btn-outline-secondary flex-fill" href="{% url 'lead_list' %}">
                <i class="fa fa-refresh me-1"></i>Clear
              </a>
            </div>
          </div>

        </div>
      </form>
    </div>




    <!-- Table -->
    <div class="col-sm-12">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive custom-scrollbar">
            <table class="display table table-hover align-middle" id="lead-1">
              <thead>
                <tr>
                  <th class="text-nowrap"><i class="fa fa-user me-1"></i>Name</th>
                  <th class="text-nowrap"><i class="fa fa-phone me-1"></i>Phone</th>
                  <th class="text-nowrap"><i class="fa fa-share-alt me-1"></i>Source</th>
                  <th class="text-nowrap"><i class="fa fa-flag me-1"></i>Priority</th>
                  <th class="text-nowrap"><i class="fa fa-clock-o me-1"></i>Last Contact</th>
                  <th class="text-nowrap">
                    <i class="fa fa-calendar me-1"></i>Next Follow-up
                    <i class="fa fa-filter ms-1 text-muted followup-filter"
                       style="cursor:pointer;"
                       title="Filtering: All"></i>
                  </th>
                  <th class="text-nowrap"><i class="fa fa-info-circle me-1"></i>Status</th>
                  <th class="text-nowrap">
                    <i class="fa fa-cogs me-1"></i>Action
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for l in leads %}
                  {% now "U" as now_ts %}
                  {% with follow_ts=l.next_followup_date|date:"U" %}
                  <tr>
                    <td class="text-nowrap">
                      <a class="font-primary text-decoration-none" href="{% url 'lead_detail' l.pk %}">
                        {{ l.name }}
                      </a>
                    </td>
                    <td class="mono">
                      {% if l.phone_number %}
                        <a class="text-decoration-none" href="tel:{{ l.phone_number }}">{{ l.phone_number }}</a>
                      {% else %}&mdash;{% endif %}
                    </td>
                    <td class="text-nowrap">
                      {% if l.lead_source %}{{ l.lead_source.name }}{% else %}&mdash;{% endif %}
                    </td>
                    <td class="text-nowrap">
                      {% with p=l.priority %}
                        {% if p == 'low' %}
                          <span class="badge badge-priority-low">Low</span>
                        {% elif p == 'medium' %}
                          <span class="badge badge-priority-medium">Medium</span>
                        {% elif p == 'high' %}
                          <span class="badge badge-priority-high">High</span>
                        {% elif p == 'urgent' %}
                          <span class="badge badge-priority-urgent">Urgent</span>
                        {% else %}
                          <span class="badge text-bg-secondary">{{ l.get_priority_display }}</span>
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td class="text-nowrap" data-order="{{ l.last_contact_date|date:'U'|default:0 }}">
                      {{ l.last_contact_date|date:"d-M-Y"|default:"—" }}
                    </td>

                    {# Follow-up cell with data-order for proper sorting #}
                    <td class="text-nowrap followup-cell"
                        data-order="{{ follow_ts|default:0 }}">
                      {% if l.next_followup_date %}
                        {% now "d-M-Y" as today_str %}
                        {% with follow_date=l.next_followup_date|date:"d-M-Y" %}
                          {% if follow_date == today_str %}
                            <span class="badge bg-success">Today {{ l.next_followup_date|date:"d-M-Y" }}</span>
                          {% elif follow_ts < now_ts %}
                            <span class="badge bg-danger">Overdue {{ l.next_followup_date|date:"d-M-Y" }}</span>
                          {% elif follow_ts <= now_ts|add:"86400" %}
                            <span class="badge bg-warning text-dark">Tomorrow {{ l.next_followup_date|date:"d-M-Y" }}</span>
                          {% else %}
                            <span class="badge bg-info">{{ l.next_followup_date|date:"d-M-Y" }}</span>
                          {% endif %}
                        {% endwith %}
                      {% else %}
                        —
                      {% endif %}
                    </td>

                    <td class="text-nowrap">
                      {% if l.converted_patient %}
                        <span class="badge text-bg-success"><i class="fa fa-check me-1"></i>Converted</span>
                      {% else %}
                        <span class="badge text-bg-warning text-dark"><i class="fa fa-hourglass-half me-1"></i>Open</span>
                      {% endif %}
                    </td>
                    <td class="text-nowrap">
                      <a class="btn btn-sm btn-outline-secondary" href="{% url 'lead_detail' l.pk %}">
                        <i class="fa fa-eye me-1"></i>View
                      </a>
                      
                    </td>
                  </tr>
                  {% endwith %}
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="small text-muted mt-2 d-flex align-items-center gap-3 d-print-none">
            <span><i class="fa fa-square text-success me-1"></i> Today</span>
            <span><i class="fa fa-square text-warning me-1"></i> Tomorrow</span>
            <span><i class="fa fa-square text-danger me-1"></i> Overdue</span>
            <span class="ms-auto d-none d-md-inline">
              <i class="fa fa-filter me-1"></i>
              Click the filter icon in “Next Follow-up” to toggle near-due rows.
            </span>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

{% load static %}
<!-- ============================================ -->
<!-- LEADS LIST -->
<!-- ============================================ -->
<style>
@media print {
  @page { 
    size: A4 portrait; 
    margin: 10mm 8mm 15mm 8mm; 
  }

  body {
    margin: 0 !important;
    padding: 0 !important;
    font-family: Arial, Helvetica, sans-serif !important;
    font-size: 10pt !important;
    line-height: 1.2 !important;
    color: #000 !important;
    background: #fff !important;
    width: 100% !important;
  }

  body * { visibility: hidden !important; }
  .print-table-container, .print-table-container * { visibility: visible !important; }

  .print-table-container {
    display: block !important;
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    background: #fff !important;
  }

  /* Updated Header */
  .print-header {
    display: block !important;
    margin-bottom: 20px;
    border-bottom: 2px solid #333;
    padding-bottom: 15px;
  }
  
  .print-header-top {
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .print-header-left { flex: 0 0 auto; }
  .print-header-center { flex: 1; text-align: center; }
  .print-header img { width: 70px; height: auto; }
  
  .print-header h1 {
    font-size: 22px; font-weight: bold;
    color: #2b5f60; margin: 0 0 8px 0;
  }
  
  .print-header-contact {
    font-size: 11px; color: #555; margin-bottom: 8px;
  }
  
  .print-header-addresses {
    display: flex !important;
    justify-content: space-between;
    gap: 15px;
    font-size: 10px;
    color: #333;
    line-height: 1.4;
  }
  
  .address-item {
    flex: 1;
    padding: 6px 8px;
    background-color: #f5f5f5 !important;
    border-left: 3px solid #2b5f60 !important;
  }
  
  .address-item strong {
    display: block;
    margin-bottom: 2px;
    color: #2b5f60;
  }

  .print-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  .print-table th, .print-table td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: left;
    font-size: 11px;
  }
  .print-table th {
    background: #2b5f60 !important;
    color: #fff !important;
    font-weight: 700;
  }
  .print-table tbody tr:nth-child(even) {
    background: #f9f9f9 !important;
  }

  .print-footer {
    text-align: center;
    margin-top: 40px;
    font-size: 10px;
    color: #666;
  }

  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
}
</style>

<div class="print-table-container d-none d-print-block" id="printLeadsWrap">
  <div class="print-header">
    <div class="print-header-top">
      <div class="print-header-left">
        <img src="{% static 'assets/images/logo/dlapp_logo_grncut.png' %}" alt="DLapp">
      </div>
      <div class="print-header-center">
        <h1>D Lapp Hair Regenerative Clinic</h1>
        <div class="print-header-contact">
          Phone: +91 8593957885 | +91 9845337296 | Email: info@dlapphairclinic.com
        </div>
      </div>
    </div>
    
    <div class="print-header-addresses">
      <div class="address-item">
        <strong>Calicut - Malaparamba</strong>
        Kottayil Arcade, Malaparamba<br>
        Calicut-673009
      </div>
      <div class="address-item">
        <strong>Calicut - Kotooli</strong>
        Breeze Building, Netaji Nagar<br>
        Kotooli, Kozhikode-673016
      </div>
      <div class="address-item">
        <strong>Kochi - Kadavanthra</strong>
        RWA-N-16, Cherupushpam Lane 1<br>
        Kadavanthra, Kochi, 682020
      </div>
    </div>
  </div>

  <div style="text-align:center; margin-bottom:20px;">
    <h2 style="font-size:18px; margin-bottom:5px;">Leads List</h2>
    <p style="font-size:11px;color:#555;">
      Source: <span id="printSource">All</span> |
      Priority: <span id="printPriority">All</span> |
      Status: <span id="printStatus">All</span> |
      Date Range: <span id="printDateRange">All Dates</span> |
      Total: <strong>{{ leads|length }}</strong>
    </p>
  </div>

  <table class="print-table" id="printLeadsTable">
    <thead>
      <tr>
        <th style="width:22%;">Name</th>
        <th style="width:16%;">Phone</th>
        <th style="width:16%;">Source</th>
        <th style="width:12%;">Priority</th>
        <th style="width:16%;">Last Contact</th>
        <th style="width:18%;">Next Follow-up</th>
        <th style="width:10%;">Status</th>
      </tr>
    </thead>
    <tbody><!-- dynamically filled --></tbody>
  </table>

  <div class="print-footer">
    Generated by {{ request.user.get_full_name|default:request.user.username }}
    on {% now "F d, Y, h:i A" %}.
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ---- DataTables (if included) ----
  if (window.jQuery && jQuery.fn.DataTable) {
    jQuery('#lead-1').DataTable({
      pageLength: 25,
      order: [[5, 'asc']], // Next Follow-up
      columnDefs: [{ orderable: false, targets: [] }]
    });
  }

  // ---- Near follow-ups toggle ----
  const filterIcon = document.querySelector(".followup-filter");
  const rows = document.querySelectorAll("#lead-1 tbody tr");
  if (filterIcon) {
    let mode = "all";
    const applyFilter = () => {
      rows.forEach(row => {
        const cell = row.querySelector(".followup-cell");
        if (!cell) return;
        const text = cell.innerText.trim();
        const isNear = /(Today|Tomorrow|Overdue)/i.test(text);
        row.style.display = (mode === "near") ? (isNear ? "" : "none") : "";
      });
    };
    filterIcon.addEventListener("click", () => {
      mode = (mode === "all") ? "near" : "all";
      filterIcon.classList.toggle("text-success", mode === "near");
      filterIcon.classList.toggle("text-muted", mode !== "near");
      filterIcon.title = (mode === "near") ? "Filtering: Near Dates" : "Filtering: All";
      applyFilter();
    });
  }

  // ---- Date filters + quick ranges (with active state) ----
  const form = document.getElementById('filterForm');
  if (form) {
    const fromI = form.querySelector('input[name="from"]');
    const toI   = form.querySelector('input[name="to"]');
    const qBtns = form.querySelectorAll('[data-range]');

    // helpers
    const pad = n => String(n).padStart(2, '0');
    const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseISO = s => {
      if (!s) return null;
      const [y,m,d] = s.split('-').map(Number);
      return new Date(y, m-1, d);
    };
    const today = (() => { const n=new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()); })();
    const start7d    = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6);
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const monthEnd   = new Date(today.getFullYear(), today.getMonth()+1, 0);

    const clearActive = () => qBtns.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
    const setActive   = (btn) => { clearActive(); if (btn) { btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); } };

    const syncMinMax = () => {
      if (!fromI || !toI) return;
      toI.min   = fromI.value || '';
      fromI.max = toI.value   || '';
    };

    // Infer active button from current inputs on load
    (function inferActiveFromInputs(){
      const f = parseISO(fromI?.value);
      const t = parseISO(toI?.value);
      if (!f || !t) { clearActive(); return; }
      const fISO = fmt(f), tISO = fmt(t);
      if (fISO === fmt(today) && tISO === fmt(today)) {
        setActive(form.querySelector('[data-range="today"]')); return;
      }
      if (fISO === fmt(start7d) && tISO === fmt(today)) {
        setActive(form.querySelector('[data-range="7d"]')); return;
      }
      if (fISO === fmt(monthStart) && tISO === fmt(monthEnd)) {
        setActive(form.querySelector('[data-range="month"]')); return;
      }
      clearActive();
    })();

    syncMinMax();

    // Compute ranges
    function setRange(kind) {
      let s = new Date(today), e = new Date(today);
      if (kind === '7d') { s = start7d; e = today; }
      else if (kind === 'month') { s = monthStart; e = monthEnd; }
      // 'today' stays today
      if (fromI) fromI.value = fmt(s);
      if (toI)   toI.value   = fmt(e);
      syncMinMax();
    }

    // Quick range clicks: set dates, mark active, submit
    qBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        setRange(btn.getAttribute('data-range'));
        setActive(btn);
        form.submit();
      });
    });

    // Manual date edits: keep constraints, clear quick-range active (NO auto-submit)
    const onDateChange = () => {
      if (fromI?.value && toI?.value && toI.value < fromI.value) {
        toI.value = fromI.value;
      }
      syncMinMax();
      clearActive();
    };
    fromI?.addEventListener('input', onDateChange);
    toI?.addEventListener('input', onDateChange);

    // Ensure clean GET on submit (avoid stale query)
    form.setAttribute('action', window.location.pathname);
  }
});

// Fill print header and trigger print
function printLeads() {
  const form = document.getElementById('filterForm');
  const srcSel = form?.querySelector('select[name="source"]');
  const priSel = form?.querySelector('select[name="priority"]');
  const stsSel = form?.querySelector('select[name="status"]');
  const fromI  = form?.querySelector('input[name="from"]');
  const toI    = form?.querySelector('input[name="to"]');

  const getText = sel => (sel && sel.selectedIndex >= 0) ? sel.options[sel.selectedIndex].text : 'All';
  document.getElementById('printSource').textContent   = getText(srcSel)   || 'All';
  document.getElementById('printPriority').textContent = getText(priSel)   || 'All';
  document.getElementById('printStatus').textContent   = getText(stsSel)   || 'All';

  let dr = 'All Dates';
  if (fromI?.value && toI?.value) dr = `From ${fromI.value} to ${toI.value}`;
  else if (fromI?.value) dr = `From ${fromI.value}`;
  else if (toI?.value)   dr = `To ${toI.value}`;
  document.getElementById('printDateRange').textContent = dr;

  // Copy visible rows into print table (without Action column)
  const rows = document.querySelectorAll('#lead-1 tbody tr');
  const printBody = document.querySelector('#printLeadsTable tbody');
  printBody.innerHTML = '';

  rows.forEach(r => {
    if (r.style.display === 'none') return; // skip hidden rows
    const clone = r.cloneNode(true);

    // remove Action column (last <td>)
    const lastCell = clone.querySelector('td:last-child');
    if (lastCell) lastCell.remove();

    printBody.appendChild(clone);
  });

  window.print();
}

</script>

{% endblock %}
