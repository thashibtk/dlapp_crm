{% extends 'base.html' %}
{% load roles %}
{% block content %}
{% load static %}

<style>
  .custom-scrollbar { max-height: 70vh; overflow: auto; }
  .custom-scrollbar thead th { position: sticky; top: 0; z-index: 2; background: #f8f9fa; }
  .table-hover tbody tr:hover { background: #fafbff; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  @media print { .d-print-none { display: none !important; } .card { box-shadow:none !important; border:none !important; } }
  
  .search-input {
    border: none;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    background: transparent;
  }
  .search-input:focus {
    box-shadow: none;
    border-bottom-color: #0d6efd;
    background: #fff;
  }
  .filter-select {
    border: none;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    background: transparent;
  }
  .filter-select:focus {
    box-shadow: none;
    border-bottom-color: #0d6efd;
    background: #fff;
  }
</style>

<!-- ============================================ -->
<!-- MEDICINES LIST -->
<!-- ============================================ -->
<style>
  .print-table-container { display: none; }

  @media print {
    @page { size: A4 portrait; margin: 10mm 8mm 15mm 8mm; }

    body { margin:0!important; padding:0!important; font-family: Arial, Helvetica, sans-serif!important;
           font-size:10pt!important; line-height:1.2!important; color:#000!important; background:#fff!important; width:100%!important; }

    body * { visibility: hidden!important; }
    .print-table-container, .print-table-container * { visibility: visible!important; }

    .print-table-container { display:block!important; position:absolute!important; left:0!important; top:0!important; width:100%!important;
                             margin:0!important; padding:0!important; background:#fff!important; }

    /* Updated Header */
    .print-header {
      display: block !important;
      margin-bottom: 20px;
      border-bottom: 2px solid #333;
      padding-bottom: 15px;
    }
    
    .print-header-top {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .print-header-left { flex: 0 0 auto; }
    .print-header-center { flex: 1; text-align: center; }
    .print-header img { width: 70px; height: auto; }
    
    .print-header h1 {
      font-size: 22px; font-weight: bold;
      color: #2b5f60; margin: 0 0 8px 0;
    }
    
    .print-header-contact {
      font-size: 11px; color: #555; margin-bottom: 8px;
    }
    
    .print-header-addresses {
      display: flex !important;
      justify-content: space-between;
      gap: 15px;
      font-size: 10px;
      color: #333;
      line-height: 1.4;
    }
    
    .address-item {
      flex: 1;
      padding: 6px 8px;
      background-color: #f5f5f5 !important;
      border-left: 3px solid #2b5f60 !important;
    }
    
    .address-item strong {
      display: block;
      margin-bottom: 2px;
      color: #2b5f60;
    }

    .print-table { width:100%; border-collapse:collapse; margin-top:20px; }

    * { -webkit-print-color-adjust: exact!important; print-color-adjust: exact!important; color-adjust: exact!important; }

    .print-table th, .print-table td { border:1px solid #ddd; padding:6px; text-align:left; font-size:11px; }
    .print-table th { background-color:#2b5f60!important; color:#fff!important; font-weight:bold; }
    .print-table tbody tr:nth-child(even) { background-color:#f9f9f9!important; }

    .print-footer { text-align:center; margin-top:50px; font-size:10px; color:#666; }
  }
</style>


<div class="container-fluid default-dashboard">
  <div class="row">

    <!-- Header -->
    <div class="col-12 project-list d-print-none">
        <div class="card">
            <div class="row align-items-center">
                <div class="col-6 p-0">
                    <ul class="nav nav-tabs border-tab d-flex" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" role="tab" aria-selected="true">
                                <i class="fa fa-medkit me-2"></i>Pharmacy • Medicines
                            </a>
                        </li>
                        <li class="nav-item">
                            <span class="text-muted small">
                                <i class="fa fa-hashtag me-1"></i>Total: <span id="total-count">{{ medicines|length }}</span>
                            </span>
                        </li>
                    </ul>
                </div>
                <div class="col-6 p-0 d-flex justify-content-end align-items-center gap-2">
                    <button class="btn btn-outline-success" type="button" onclick="printMedicines()">
                      <i class="fa fa-print me-2"></i>Print
                    </button>
                    {% if request.user|in_group:"PharmacyManager" or request.user|in_group:"OperationsManager" %}
                    <a class="btn btn-primary" href="{% url 'pharmacy_medicine_create' %}">
                        <i class="fa fa-plus-square me-2"></i>Add Medicine
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="col-sm-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0 text-muted">
            <i class="fa fa-list me-2"></i>Medicine Inventory
          </h6>
          <div class="text-muted small">
            Showing <span id="visible-count">{{ medicines|length }}</span> of {{ medicines|length }} medicine{{ medicines|length|pluralize }}
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive custom-scrollbar">
            <table class="table table-hover table-sm align-middle" id="medicineTable">
              <thead>
                <tr>
                  <th>
                    <div class="d-flex flex-column">
                      <span><i class="fa fa-font me-1"></i>Name</span>
                      <input type="text" class="search-input mt-1" placeholder="Search name..." id="searchName">
                    </div>
                  </th>
                  <th class="text-nowrap">
                    <div class="d-flex flex-column">
                      <span><i class="fa fa-tag me-1"></i>Type</span>
                      <select class="filter-select mt-1" id="filterType">
                        <option value="">All Types</option>
                        {% for type_choice in medicine_types %}
                          <option value="{{ type_choice.0 }}">{{ type_choice.1 }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </th>
                  <th>
                    <div class="d-flex flex-column">
                      <span><i class="fa fa-flask me-1"></i>Strength</span>
                      <input type="text" class="search-input mt-1" placeholder="Search..." id="searchStrength">
                    </div>
                  </th>
                  <th>
                    <div class="d-flex flex-column">
                      <span><i class="fa fa-folder me-1"></i>Category</span>
                      <select class="filter-select mt-1" id="filterCategory">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                          <option value="{{ category.name }}">{{ category.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </th>
                    
                  </th>
                  <th class="text-end text-nowrap">
                    <div class="d-flex flex-column">
                      <span><i class="fa fa-inr me-1"></i>Price</span>
                      <input type="text" class="search-input mt-1" placeholder="Min-Max" id="searchPrice">
                    </div>
                  </th>
                  <th class="text-nowrap">
                    <div class="d-flex flex-column">
                      <span><i class="fa fa-toggle-on me-1"></i>Status</span>
                      <select class="filter-select mt-1" id="filterStatus">
                        <option value="">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                      </select>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for m in medicines %}
                <tr data-name="{{ m.name|lower }}" 
                    data-manufacturer="{{ m.manufacturer|default:""|lower }}"
                    data-type="{{ m.medicine_type }}"
                    data-strength="{{ m.strength|default:""|lower }}"
                    data-category="{{ m.category.name|default:"" }}"
                    data-price="{{ m.selling_price }}"
                    data-status="{% if m.is_active %}active{% else %}inactive{% endif %}">
                  <td>
                    <a class="font-primary text-decoration-none" href="{% url 'pharmacy_medicine_detail' m.pk %}">
                      {{ m.name }}
                      {% if m.manufacturer %}<div class="small text-muted">{{ m.manufacturer }}</div>{% endif %}
                    </a>
                  </td>
                  <td class="text-nowrap">{{ m.get_medicine_type_display }}</td>
                  <td>{{ m.strength|default:"—" }}</td>
                  <td>{{ m.category.name|default:"—" }}</td>
                  <td class="text-start mono">₹ {{ m.selling_price }}</td>
                  <td>
                    {% if m.is_active %}
                      <span class="badge text-bg-success"><i class="fa fa-check me-1"></i>Active</span>
                    {% else %}
                      <span class="badge text-bg-secondary"><i class="fa fa-minus-circle me-1"></i>Inactive</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr id="no-data-row">
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="fa fa-inbox me-2"></i>No medicines found.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>


<div class="print-table-container" id="printMedicinesWrap">
  <div class="print-header">
    <div class="print-header-top">
      <div class="print-header-left">
        <img src="{% static 'assets/images/logo/dlapp_logo_grncut.png' %}" alt="DLapp">
      </div>
      <div class="print-header-center">
        <h1>D Lapp Hair Regenerative Clinic</h1>
        <div class="print-header-contact">
          Phone: +91 8593957885 | +91 9845337296 | Email: info@dlapphairclinic.com
        </div>
      </div>
    </div>
    
    <div class="print-header-addresses">
      <div class="address-item">
        <strong>Calicut - Malaparamba</strong>
        Kottayil Arcade, Malaparamba<br>
        Calicut-673009
      </div>
      <div class="address-item">
        <strong>Calicut - Kotooli</strong>
        Breeze Building, Netaji Nagar<br>
        Kotooli, Kozhikode-673016
      </div>
      <div class="address-item">
        <strong>Kochi - Kadavanthra</strong>
        RWA-N-16, Cherupushpam Lane 1<br>
        Kadavanthra, Kochi, 682020
      </div>
    </div>
  </div>

  <div style="text-align:center; margin-bottom:20px;">
    <h2 style="font-size:18px; margin-bottom:5px;">Pharmacy • Medicine Inventory</h2>
    <p style="font-size:11px;color:#555;">
      Name: <span id="pName"></span> |
      Type: <span id="pType"></span> |
      Strength: <span id="pStrength"></span> |
      Category: <span id="pCategory"></span> |
      Price: <span id="pPrice"></span> |
      Status: <span id="pStatus"></span>
    </p>
  </div>

  <table class="print-table" id="printMedicinesTable">
    <thead>
      <tr>
        <th style="width:4%;">#</th>
        <th style="width:26%;">Name</th>
        <th style="width:12%;">Type</th>
        <th style="width:12%;">Strength</th>
        <th style="width:18%;">Category</th>
        <th style="width:12%;">Price</th>
        <th style="width:10%;">Status</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filled dynamically from current visible rows -->
    </tbody>
  </table>

  <div class="print-footer">
    Generated by {{ request.user.get_full_name|default:request.user.username }} on {% now "F d, Y, h:i A" %}
  </div>
</div>


<script>
function printMedicines() {
  // Source table (current on-screen)
  const srcTable = document.getElementById('medicineTable');
  const rows = Array.from(srcTable.querySelectorAll('tbody tr')).filter(r => r.id !== 'no-data-row');

  // Filter inputs
  const nameI = document.getElementById('searchName');
  const typeI = document.getElementById('filterType');
  const strengthI = document.getElementById('searchStrength');
  const categoryI = document.getElementById('filterCategory');
  const priceI = document.getElementById('searchPrice');
  const statusI = document.getElementById('filterStatus');

  // Fill filter summary (like appointments page does)
  const orAll = (v, txtAll='All') => (v && v.trim() !== '' ? v : txtAll);
  document.getElementById('pName').textContent = orAll(nameI.value, 'Any');
  document.getElementById('pType').textContent = typeI.value
      ? (typeI.options[typeI.selectedIndex]?.text || typeI.value)
      : 'All';
  document.getElementById('pStrength').textContent = orAll(strengthI.value, 'Any');
  document.getElementById('pCategory').textContent = categoryI.value || 'All';
  document.getElementById('pPrice').textContent = orAll(priceI.value, 'Any');
  document.getElementById('pStatus').textContent = statusI.value
      ? (statusI.options[statusI.selectedIndex]?.text || statusI.value)
      : 'All';

  // Target print table body
  const printTBody = document.querySelector('#printMedicinesTable tbody');
  printTBody.innerHTML = '';

  // Build rows ONLY from currently visible ones
  let i = 0;
  rows.forEach(r => {
    const isVisible = r.style.display !== 'none';
    if (!isVisible) return;

    const cells = r.querySelectorAll('td');
    const nameCell = cells[0];
    const typeCell = cells[1];
    const strengthCell = cells[2];
    const categoryCell = cells[3];
    const priceCell = cells[4];
    const statusCell = cells[5];

    const name = nameCell?.innerText.trim() || '';
    const type = typeCell?.innerText.trim() || '';
    const strength = strengthCell?.innerText.trim() || '';
    const category = categoryCell?.innerText.trim() || '';
    const price = priceCell?.innerText.trim() || '';
    const status = statusCell?.innerText.trim() || '';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${++i}</td>
      <td>${name}</td>
      <td>${type}</td>
      <td>${strength || '—'}</td>
      <td>${category || '—'}</td>
      <td>${price}</td>
      <td>${status}</td>
    `;
    printTBody.appendChild(tr);
  });

  // If nothing visible, show an empty state row in print as well
  if (i === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="7" style="text-align:center; color:#666;">No medicines match the current filters.</td>`;
    printTBody.appendChild(tr);
  }

  window.print();
}
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('medicineTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr:not(#no-data-row)'));
    const visibleCountElement = document.getElementById('visible-count');
    const noDataRow = document.getElementById('no-data-row');
    
    // Get all filter elements
    const searchName = document.getElementById('searchName');
    const filterType = document.getElementById('filterType');
    const searchStrength = document.getElementById('searchStrength');
    const filterCategory = document.getElementById('filterCategory');
    const searchPrice = document.getElementById('searchPrice');
    const filterStatus = document.getElementById('filterStatus');
    
    function filterTable() {
        let visibleCount = 0;
        const nameSearch = searchName.value.toLowerCase().trim();
        const typeFilter = filterType.value;
        const strengthSearch = searchStrength.value.toLowerCase().trim();
        const categoryFilter = filterCategory.value;
        const priceSearch = searchPrice.value.trim();
        const statusFilter = filterStatus.value;
        
        // Parse price range (e.g., "10-100" or "50" or ">100" or "<50")
        let minPrice = null, maxPrice = null;
        if (priceSearch) {
            if (priceSearch.includes('-')) {
                const parts = priceSearch.split('-');
                minPrice = parseFloat(parts[0]) || null;
                maxPrice = parseFloat(parts[1]) || null;
            } else if (priceSearch.startsWith('>')) {
                minPrice = parseFloat(priceSearch.substring(1)) || null;
            } else if (priceSearch.startsWith('<')) {
                maxPrice = parseFloat(priceSearch.substring(1)) || null;
            } else {
                const exactPrice = parseFloat(priceSearch);
                if (!isNaN(exactPrice)) {
                    minPrice = exactPrice;
                    maxPrice = exactPrice;
                }
            }
        }
        
        rows.forEach(row => {
            const name = row.dataset.name || '';
            const manufacturer = row.dataset.manufacturer || '';
            const type = row.dataset.type || '';
            const strength = row.dataset.strength || '';
            const category = row.dataset.category || '';
            const price = parseFloat(row.dataset.price) || 0;
            const status = row.dataset.status || '';
            
            let visible = true;
            
            // Name search (includes manufacturer)
            if (nameSearch && !name.includes(nameSearch) && !manufacturer.includes(nameSearch)) {
                visible = false;
            }
            
            // Type filter
            if (typeFilter && type !== typeFilter) {
                visible = false;
            }
            
            // Strength search
            if (strengthSearch && !strength.includes(strengthSearch)) {
                visible = false;
            }
            
            // Category filter
            if (categoryFilter && category !== categoryFilter) {
                visible = false;
            }
            
            // Price filter
            if (minPrice !== null && price < minPrice) {
                visible = false;
            }
            if (maxPrice !== null && price > maxPrice) {
                visible = false;
            }
            
            // Status filter
            if (statusFilter && status !== statusFilter) {
                visible = false;
            }
            
            row.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });
        
        // Update visible count
        visibleCountElement.textContent = visibleCount;
        
        // Show/hide no data message
        if (noDataRow) {
            noDataRow.style.display = (visibleCount === 0 && rows.length > 0) ? '' : 'none';
        }
    }
    
    // Add event listeners
    searchName.addEventListener('input', filterTable);
    filterType.addEventListener('change', filterTable);
    searchStrength.addEventListener('input', filterTable);
    filterCategory.addEventListener('change', filterTable);
    searchPrice.addEventListener('input', filterTable);
    filterStatus.addEventListener('change', filterTable);
    
    // Add clear filters functionality
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === '/') {
            e.preventDefault();
            searchName.value = '';
            filterType.value = '';
            searchStrength.value = '';
            filterCategory.value = '';
            searchPrice.value = '';
            filterStatus.value = '';
            filterTable();
            searchName.focus();
        }
    });
});
</script>

{% endblock %}