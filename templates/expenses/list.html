{% extends 'base.html' %}
{% load roles %}
{% block content %}
<style>
  /* Adjusting the search filter within the flex container */
  div.dataTables_wrapper div.dataTables_filter {
    position: static;
    top: auto;
    right: auto;
    flex: 1 1 auto;
    min-width: 200px;
    max-width: 300px;
    margin-left: auto;
    text-align: right;
  }
  @media (max-width: 767px) {
    div.dataTables_wrapper div.dataTables_filter {
      flex: 1 1 100%;
      min-width: unset;
      max-width: unset;
      margin-left: 0;
      text-align: left;
      order: -1;
      padding: 10px 0;
    }
  }
</style>

<style>
  /* --- A4 Print Styles (same style as Appointments) --- */
  .expense-list-print { display: none; }

  @media print {
    @page { size: A4 portrait; margin: 10mm 8mm 15mm 8mm; }

    body {
      margin: 0 !important; padding: 0 !important;
      font-family: Arial, Helvetica, sans-serif !important;
      font-size: 10pt !important; line-height: 1.2 !important;
      color: #000 !important; background: #fff !important; width: 100% !important;
    }

    body * { visibility: hidden !important; }
    .expense-list-print, .expense-list-print * { visibility: visible !important; }

    .expense-list-print {
      display: block !important; position: absolute !important;
      left: 0 !important; top: 0 !important; width: 100% !important;
      margin: 0 !important; padding: 0 !important; background: #fff !important;
    }

    /* Updated Header Layout */
    .print-header {
      display: block !important;
      margin-bottom: 20px;
      border-bottom: 2px solid #333;
      padding-bottom: 15px;
    }
    
    .print-header-top {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .print-header-left { flex: 0 0 auto; }
    .print-header-center { flex: 1; text-align: center; }
    .print-header img { width: 70px; height: auto; }
    
    .print-header h1 {
      font-size: 22px; font-weight: bold;
      color: #2b5f60; margin: 0 0 8px 0;
    }
    
    .print-header-contact {
      font-size: 11px; color: #555; margin-bottom: 8px;
    }
    
    .print-header-addresses {
      display: flex !important;
      justify-content: space-between;
      gap: 15px;
      font-size: 10px;
      color: #333;
      line-height: 1.4;
    }
    
    .address-item {
      flex: 1;
      padding: 6px 8px;
      background-color: #f5f5f5 !important;
      border-left: 3px solid #2b5f60 !important;
    }
    
    .address-item strong {
      display: block;
      margin-bottom: 2px;
      color: #2b5f60;
    }

    .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .print-table th, .print-table td {
      border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 11px;
    }
    .print-table th { background-color: #2b5f60 !important; color: #fff !important; font-weight: bold; }
    .print-table tbody tr:nth-child(even) { background-color: #f9f9f9 !important; }
    .print-table tfoot th { background-color: transparent !important; color: #000 !important; }

    .print-footer { text-align: center; margin-top: 32px; font-size: 10px; color: #666; }
    .d-print-none { display: none !important; }
    .card { box-shadow: none !important; border: none !important; }

    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      color-adjust: exact !important;
    }
  }
</style>

<div class="container-fluid default-dashboard">
  <div class="row">
    <!-- Header -->
    <div class="col-12 project-list">
      <div class="card">
        <div class="row align-items-center">
          <div class="col-6 p-0">
            <ul class="nav nav-tabs border-tab d-flex" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" href="#" role="tab" aria-selected="true">
                  <i class="fa fa-money me-2"></i>Expenses
                </a>
              </li>
            </ul>
          </div>
          <div class="col-6 p-0 d-flex justify-content-end align-items-center gap-2">
            <a class="btn btn-primary" href="{% url 'expense_create' %}">
              <i class="fa fa-plus-square me-2"></i>New Expense
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="col-md-12">
      <form class="card p-3 mb-3 d-print-none" method="get" id="filterForm" action="{% url 'expense_list' %}">
        <div class="row g-3 align-items-end">
          <!-- Quick range -->
          <div class="col-12 col-lg-4">
            <label class="form-label mb-1 small text-muted"><i class="fa fa-bolt me-1"></i>Quick range</label>
            <input type="hidden" name="range" id="rangeField" value="{{ selected.range|default:'' }}">
            <div class="btn-group w-100" role="group">
              <button class="btn btn-outline-secondary {% if selected.range == 'today' %}active{% endif %}" type="button" data-range="today" aria-pressed="{% if selected.range == 'today' %}true{% else %}false{% endif %}">
                <i class="fa fa-calendar me-1"></i>Today
              </button>
              <button class="btn btn-outline-secondary {% if selected.range == '7d' %}active{% endif %}" type="button" data-range="7d" aria-pressed="{% if selected.range == '7d' %}true{% else %}false{% endif %}">
                <i class="fa fa-calendar me-1"></i>Last 7 days
              </button>
              <button class="btn btn-outline-secondary {% if selected.range == 'month' %}active{% endif %}" type="button" data-range="month" aria-pressed="{% if selected.range == 'month' %}true{% else %}false{% endif %}">
                <i class="fa fa-calendar me-1"></i>This month
              </button>
            </div>
          </div>

          <!-- From / To -->
          <div class="col-6 col-lg-2">
            <label class="form-label mb-1 small text-muted"><i class="fa fa-sign-in me-1"></i>From</label>
            <input type="date" class="form-control" name="from"
                  value="{{ selected.from|date:'Y-m-d' }}"
                  max="{{ selected.to|date:'Y-m-d' }}">
          </div>
          <div class="col-6 col-lg-2">
            <label class="form-label mb-1 small text-muted"><i class="fa fa-sign-out me-1"></i>To</label>
            <input type="date" class="form-control" name="to"
                  value="{{ selected.to|date:'Y-m-d' }}"
                  min="{{ selected.from|date:'Y-m-d' }}">
          </div>

          <!-- Status -->
          <div class="col-12 col-lg-2">
            <label class="form-label mb-1 small text-muted"><i class="fa fa-list me-1"></i>Status</label>
            <select class="form-select" name="status">
              {% for v,label in status_choicesfilter %}
                <option value="{{ v }}" {% if selected.status == v %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-12 col-lg-2">
            <label class="form-label mb-1 small text-muted"><i class="fa fa-list me-1"></i>All Pending</label>
            <button
              type="button"
              id="allPendingBtn"
              class="btn w-100 btn-outline-secondary {% if selected.status == 'pending' and not selected.range and not selected.from and not selected.to %}active{% endif %}"
              aria-pressed="{% if selected.status == 'pending' and not selected.range and not selected.from and not selected.to %}true{% else %}false{% endif %}">
              <i class="fa fa-exclamation-circle me-2"></i>All Pending
            </button>
          </div>

          <!-- Actions -->
          <div class="col-12 d-flex flex-wrap gap-2 justify-content-lg-end">
            <button class="btn btn-outline-secondary" type="submit">
              <i class="fa fa-filter me-2"></i>Filter
            </button>

            <a class="btn btn-light" href="{% url 'expense_list' %}">
              <i class="fa fa-refresh me-2"></i>Clear
            </a>

            <button type="button" class="btn btn-outline-success" onclick="printExpenses()">
              <i class="fa fa-print me-2"></i>Print
            </button>
          </div>
        </div>
      </form>
    </div>


    <!-- Table -->
    <div class="col-sm-12">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive custom-scrollbar">
            <table class="display table table-hover align-middle" id="basic-1">
              <thead>
                <tr>
                  <th><i class="fa fa-calendar me-1"></i>Date</th>
                  <th><i class="fa fa-tag me-1"></i>Category</th>
                  <th><i class="fa fa-file me-1"></i>Description</th>
                  <th class="text-end"><i class="fa fa-inr me-1"></i>Amount</th>
                  <th class="text-nowrap"><i class="fa fa-info-circle me-1"></i>Status</th>
                  <th class="text-nowrap d-print-none"><i class="fa fa-cog me-1"></i>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for e in expenses %}
                <tr>
                  <td class="text-nowrap">{{ e.expense_date|date:"d-M-Y" }}</td>
                  <td>{{ e.category.name }}</td>
                  <td class="text-truncate" style="max-width:420px;">
                    <a class="text-decoration-none" href="{% url 'expense_detail' e.pk %}">
                      {{ e.description|default:"—" }}
                    </a>
                  </td>
                  <td class="text-end">₹ {{ e.amount }}</td>
                  <td>
                    {% if e.status == 'pending' %}
                      <span class="badge text-bg-warning text-dark"><i class="fa fa-hourglass-half me-1"></i>Pending</span>
                    {% elif e.status == 'approved' %}
                      <span class="badge text-bg-info"><i class="fa fa-check me-1"></i>Approved</span>
                    {% elif e.status == 'paid' %}
                      <span class="badge text-bg-success"><i class="fa fa-circle-check me-1"></i>Paid</span>
                    {% elif e.status == 'rejected' %}
                      <span class="badge text-bg-danger"><i class="fa fa-times me-1"></i>Rejected</span>
                    {% else %}
                      <span class="badge text-bg-secondary">{{ e.get_status_display }}</span>
                    {% endif %}
                  </td>
                  <td class="d-print-none">
                    <div class="d-flex flex-wrap gap-1">
                      
                      <a class="btn btn-sm btn-outline-secondary" href="{% url 'expense_detail' e.pk %}">
                        <i class="fa fa-eye me-1"></i>View
                      </a>
                      
                      <a class="btn btn-sm btn-primary" href="{% url 'expense_update' e.pk %}">
                        <i class="fa fa-pencil me-1"></i>Edit
                      </a>

                      {% if request.user|in_group:"OperationsManager" and e.status == 'pending' %}
                        <form method="post" action="{% url 'expense_approve' e.pk %}" class="d-inline expense-approve-form">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-success">
                            <i class="fa fa-check me-1"></i>Approve
                          </button>
                        </form>

                        <form method="post" action="{% url 'expense_reject' e.pk %}" class="d-inline expense-reject-form">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-danger">
                            <i class="fa fa-times me-1"></i>Reject
                          </button>
                        </form>
                      {% endif %}

                      {% if e.status == 'approved' %}
                        {% if request.user|in_group:"OperationsManager" or request.user|in_group:"Doctor" %}
                        <form method="post" action="{% url 'expense_mark_paid' e.pk %}" class="d-inline expense-paid-form">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-success">
                            <i class="fa fa-inr me-1"></i>Mark Paid
                          </button>
                        </form>
                        {% endif %}
                      {% endif %}

                      
                    </div>
                  </td>
       
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center text-muted py-3">No expenses found.</td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="3" class="text-end">Total:</th>
                  <th class="text-end">₹ {{ total_amount }}</th>
                  <th colspan="2"></th>
                </tr>
              </tfoot>
            </table>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<style>.text-truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}</style>

{% load static %}
<div class="expense-list-print">
  <div class="print-header">
    <div class="print-header-top">
      <div class="print-header-left">
        <img src="{% static 'assets/images/logo/dlapp_logo_grncut.png' %}" alt="DLapp">
      </div>
      <div class="print-header-center">
        <h1>D Lapp Hair Regenerative Clinic</h1>
        <div class="print-header-contact">
          Phone: +91 8593957885 | +91 9845337296 | Email: info@dlapphairclinic.com
        </div>
      </div>
    </div>
    
    <div class="print-header-addresses">
      <div class="address-item">
        <strong>Calicut - Malaparamba</strong>
        Kottayil Arcade, Malaparamba<br>
        Calicut-673009
      </div>
      <div class="address-item">
        <strong>Calicut - Kotooli</strong>
        Breeze Building, Netaji Nagar<br>
        Kotooli, Kozhikode-673016
      </div>
      <div class="address-item">
        <strong>Kochi - Kadavanthra</strong>
        RWA-N-16, Cherupushpam Lane 1<br>
        Kadavanthra, Kochi, 682020
      </div>
    </div>
  </div>

  <div style="text-align:center; margin-bottom: 10px;">
    <h2 style="font-size:18px; margin:0 0 6px;">Expenses List</h2>
    <p style="font-size:11px;color:#555;">
      Status: <span id="printStatus"></span> |
      Date Range: <span id="printDateRange"></span> |
      Total Amount: <strong>{{ total_amount|floatformat:2 }}</strong> 

    </p>
  </div>

  <table class="print-table">
    <thead>
      <tr>
        <th style="width:16%;">Date</th>
        <th style="width:20%;">Category</th>
        <th style="width:36%;">Description</th>
        <th style="width:14%;">Amount</th>
        <th style="width:14%;">Status</th>
      </tr>
    </thead>
    <tbody>
      {% for e in expenses %}
      <tr>
        <td>{{ e.expense_date|date:"d-M-Y" }}</td>
        <td>{{ e.category.name }}</td>
        <td>{{ e.description|default:"—" }}</td>
        <td>₹ {{ e.amount|floatformat:2 }}</td>
        <td>
          {% if e.status == 'pending' %}Pending
          {% elif e.status == 'approved' %}Approved
          {% elif e.status == 'paid' %}Paid
          {% elif e.status == 'rejected' %}Rejected
          {% else %}{{ e.get_status_display }}
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" style="text-align:center;color:#666;">No expenses found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="print-footer">
    Generated by {{ request.user.get_full_name|default:request.user.username }} on {% now "F d, Y, h:i A" %}.
  </div>
</div>


<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // Reusable SweetAlert confirmation with DLapp theme
  function confirmAction(form, title, text, confirmButtonText, icon = 'question', confirmColor = '#16a34a') {
    event.preventDefault();
    Swal.fire({
      title: title,
      text: text,
      icon: icon,
      showCancelButton: true,
      background: '#f9fafb',             // light background
      color: '#111827',                  // dark text
      confirmButtonColor: confirmColor,  // DLapp green
      cancelButtonColor: '#d33',         // red cancel
      confirmButtonText: confirmButtonText,
      cancelButtonText: 'Cancel',
      customClass: {
        popup: 'rounded-3xl shadow-lg',
        title: 'text-lg font-semibold',
        confirmButton: 'px-4 py-2 rounded-lg font-medium',
        cancelButton: 'px-4 py-2 rounded-lg font-medium'
      }
    }).then((result) => {
      if (result.isConfirmed) {
        form.submit();
      }
    });
  }

  // Approve
  document.querySelectorAll('.expense-approve-form').forEach(form => {
    form.addEventListener('submit', function (event) {
      confirmAction(form, 'Approve Expense', 'Are you sure you want to approve this expense?', 'Yes, Approve!', 'success');
    });
  });

  // Reject
  document.querySelectorAll('.expense-reject-form').forEach(form => {
    form.addEventListener('submit', function (event) {
      confirmAction(form, 'Reject Expense', 'Do you really want to reject this expense?', 'Yes, Reject!', 'warning', '#ef4444');
    });
  });

  // Mark Paid
  document.querySelectorAll('.expense-paid-form').forEach(form => {
    form.addEventListener('submit', function (event) {
      confirmAction(form, 'Mark as Paid', 'Confirm marking this expense as PAID?', 'Yes, Mark Paid!', 'info', '#16a34a');
    });
  });

});
</script>


<script>
function printExpenses() {
  const form = document.getElementById('filterForm');
  const statusSel = form ? form.querySelector('select[name="status"]') : null;
  const fromI = form ? form.querySelector('input[name="from"]') : null;
  const toI   = form ? form.querySelector('input[name="to"]')   : null;

  // Status text
  document.getElementById('printStatus').textContent =
    statusSel && statusSel.value ? statusSel.options[statusSel.selectedIndex].text : 'All';

  // Date range text
  const from = fromI && fromI.value ? fromI.value : '';
  const to   = toI   && toI.value   ? toI.value   : '';
  let dr = 'All Dates';
  if (from && to) dr = `From ${from} to ${to}`;
  else if (from)  dr = `From ${from}`;
  else if (to)    dr = `To ${to}`;
  document.getElementById('printDateRange').textContent = dr;

  window.print();
}
</script>

<script>  
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('filterForm');
  if (!form) return;

  const fromI = form.querySelector('input[name="from"]');
  const toI   = form.querySelector('input[name="to"]');
  const rangeField = document.getElementById('rangeField');
  const qBtns = form.querySelectorAll('[data-range]');
  const allPendingBtn = document.getElementById('allPendingBtn');

  const clearActive = () => qBtns.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
  const setActive = (btn) => { clearActive(); if (btn) { btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); } };

  // Quick ranges -> set hidden range, clear dates, submit
  qBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const r = btn.getAttribute('data-range');
      if (rangeField) rangeField.value = r;
      if (fromI) fromI.value = '';
      if (toI)   toI.value   = '';
      setActive(btn);
      form.submit();
    });
  });

  // Manual date edits -> clear quick-range selection (NO auto-submit)
  const onDateChange = () => {
    if (rangeField) rangeField.value = '';
    clearActive();
    // keep min/max consistent
    if (fromI?.value && toI?.value && toI.value < fromI.value) {
      toI.value = fromI.value;
    }
    toI.min = fromI?.value || '';
    fromI.max = toI?.value || '';
  };
  fromI?.addEventListener('input', onDateChange);
  toI?.addEventListener('input', onDateChange);

  // All Pending -> status=pending & pending_all=1; drop range/from/to
  allPendingBtn?.addEventListener('click', () => {
    const url = new URL(window.location);
    url.searchParams.set('status', 'pending');
    url.searchParams.set('pending_all', '1');
    url.searchParams.delete('range');
    url.searchParams.delete('from');
    url.searchParams.delete('to');
    window.location.href = url.toString();
  });

  // Ensure clean GET on Filter (path-only action)
  form.setAttribute('action', window.location.pathname);
});
</script>


{% endblock %}
