  {% extends 'base.html' %}
  {% load roles %}
  {% block content %}

  
<style>
    /* --- A4 Print Styles (shared across pages) --- */
    .expense-print-container { display: none; }

    @media print {
      @page { size: A4 portrait; margin: 10mm 8mm 15mm 8mm; }

      body {
        margin: 0 !important; padding: 0 !important;
        font-family: Arial, Helvetica, sans-serif !important;
        font-size: 10pt !important; line-height: 1.2 !important;
        color: #000 !important; background: #fff !important; width: 100% !important;
      }

      /* Hide everything by default */
      body * { visibility: hidden !important; }

      /* Only show the print container */
      .expense-print-container, .expense-print-container * { visibility: visible !important; }

      .expense-print-container {
        display: block !important; position: absolute !important;
        left: 0 !important; top: 0 !important; width: 100% !important;
        margin: 0 !important; padding: 0 !important; background: #fff !important;
      }

      /* Updated Header Layout */
      .print-header {
        display: block !important;
        margin-bottom: 20px;
        border-bottom: 2px solid #333;
        padding-bottom: 15px;
      }
      
      .print-header-top {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      
      .print-header-left { 
        flex: 0 0 auto;
      }
      
      .print-header-center {
        flex: 1;
        text-align: center;
      }
      
      .print-header img { 
        width: 70px; 
        height: auto; 
      }
      
      .print-header h1 {
        font-size: 22px;
        font-weight: bold;
        color: #2b5f60;
        margin: 0 0 8px 0;
      }
      
      .print-header-contact {
        font-size: 11px;
        color: #555;
        margin-bottom: 8px;
      }
      
      .print-header-addresses {
        display: flex !important;
        justify-content: space-between;
        gap: 15px;
        font-size: 10px;
        color: #333;
        line-height: 1.4;
      }
      
      .address-item {
        flex: 1;
        padding: 6px 8px;
        background-color: #f5f5f5 !important;
        border-left: 3px solid #2b5f60 !important;
      }
      
      .address-item strong {
        display: block;
        margin-bottom: 2px;
        color: #2b5f60;
      }

      .print-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      .print-table th, .print-table td {
        border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 11px;
      }
      .print-table th { background-color: #2b5f60 !important; color: #fff !important; font-weight: bold; }
      .print-table tbody tr:nth-child(even) { background-color: #f9f9f9 !important; }

      .section-title { font-weight: 700; margin-top: 18px; margin-bottom: 6px; }
      .print-footer { text-align: center; margin-top: 32px; font-size: 10px; color: #666; }

      /* Hide UI-only elements */
      .d-print-none { display: none !important; }
      .card { box-shadow: none !important; border: none !important; }
    }
  </style>

  <div class="container-fluid default-dashboard">
    <div class="row">
      <!-- Header -->
      <div class="col-12 project-list d-print-none">
        <div class="card">
          <div class="row align-items-center ">
            
            <!-- Left side -->
            <div class="col-12 col-md-6 mb-2 mb-md-0">
              <ul class="nav nav-tabs border-tab d-flex" role="tablist">
                <li class="nav-item">
                  <a class="nav-link active" href="#" role="tab" aria-selected="true">
                    <i class="fa fa-file-text me-2"></i>
                    Expense • <span class="text-muted">{{ expense.category.name }}</span>
                  </a>
                </li>
              </ul>
            </div>

            <!-- Right side -->
            <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end gap-2">
              <a class="btn btn-outline-secondary" href="{% url 'expense_list' %}">
                <i class="fa fa-arrow-left me-2"></i>Back
              </a>
              {% if request.user == expense.requested_by %}
              <a class="btn btn-primary" href="{% url 'expense_update' expense.pk %}">
                <i class="fa fa-pencil me-2"></i>Edit
              </a>
              {% endif %}
              {% if request.user|in_group:"OperationsManager"  %}
              <a class="btn btn-primary" href="{% url 'expense_update' expense.pk %}">
                <i class="fa fa-pencil me-2"></i>Edit
              </a>
              {% endif %}
              
              <button class="btn btn-outline-success" type="button" onclick="printExpense()">
                <i class="fa fa-print me-2"></i>Print
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Body -->
      <div class="col-12">
          <div class="card p-4">
              <div class="row g-3">
              <div class="col-md-6">
                  <div class="small text-muted fw-semibold mb-1"><i class="fa fa-info-circle me-1"></i>Overview</div>
                  <div class="mb-2 mt-3"><b><i class="fa fa-calendar me-1"></i>Date:</b> {{ expense.expense_date|date:"d-M-Y" }}</div>
                  <div class="mb-2 mt-3"><b><i class="fa fa-tag me-1"></i>Category:</b> {{ expense.category.name }}</div>
                  <div class="mb-2 mt-3"><b><i class="fa fa-inr me-1"></i>Amount:</b> ₹ {{ expense.amount }}</div>
                  <div class="mb-2 mt-3"><b><i class="fa fa-check-circle me-1"></i>Status:</b>
                  {% if expense.status == 'pending' %}
                  <span class="badge text-bg-warning text-dark">Pending</span>
                  {% elif expense.status == 'approved' %}
                  <span class="badge text-bg-info">Approved</span>
                  {% elif expense.status == 'paid' %}
                  <span class="badge text-bg-success">Paid</span>
                  {% elif expense.status == 'rejected' %}
                  <span class="badge text-bg-danger">Rejected</span>
                  {% else %}
                  <span class="badge text-bg-secondary">{{ expense.get_status_display }}</span>
                  {% endif %}
                  </div>
              </div>
              <div class="col-md-6">
                  <div class="small text-muted fw-semibold mb-1"><i class="fa fa-clock me-1"></i>Meta</div>
                  <div><b><i class="fa fa-user me-1 mt-3"></i>Submitted By:</b> {{ expense.requested_by|default:"—" }}</div>
                  {% if expense.approved_by %}<div class="mb-2 mt-3"><b><i class="fa fa-user me-1"></i>Approved By:</b> {{ expense.approved_by }}</div>{% endif %}
                  {% if expense.created_at %}<div class="mb-2 mt-3"><b><i class="fa fa-plus-circle me-1"></i>Created:</b> {{ expense.created_at|date:"d-M-Y h:i A" }}</div>{% endif %}
                  {% if expense.updated_at %}<div class="mb-2 mt-3"><b><i class="fa fa-pencil me-1"></i>Updated:</b> {{ expense.updated_at|date:"Y-m-d H:i" }}</div>{% endif %}
              </div>
              <div class="col-12">
                  <div class="small text-muted fw-semibold mb-1"><i class="fa fa-comment me-1"></i>Description</div>
                  <div>{{ expense.description|linebreaksbr|default:"—" }}</div>
              </div>
              {% if expense.attachment %}
              <div class="col-12">
                  <div class="small text-muted fw-semibold mb-1"><i class="fa fa-paperclip me-1"></i>attachment</div>
                  <a href="{{ expense.attachment.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                  <i class="fa fa-eye me-1"></i>View / Download
                  </a>
                  {% if ".jpg" in expense.attachment.url|lower or ".png" in expense.attachment.url|lower or ".jpeg" in expense.attachment.url|lower %}
                  <div class="mt-2">
                  <img src="{{ expense.attachment.url }}" class="img-fluid rounded border shadow-sm" alt="attachment preview">
                  </div>
                  {% endif %}
              </div>
              {% endif %}
              </div>
          </div>
      </div>

    </div>
  </div>

  {% load static %}
  <div class="expense-print-container">
    <div class="print-header">
      <div class="print-header-top">
        <div class="print-header-left">
          <img src="{% static 'assets/images/logo/dlapp_logo_grncut.png' %}" alt="DLapp">
        </div>
        <div class="print-header-center">
          <h1>D Lapp Hair Regenerative Clinic</h1>
          <div class="print-header-contact">
            Phone: +91 8593957885 | +91 9845337296 | Email: info@dlapphairclinic.com
          </div>
        </div>
      </div>
      
      <div class="print-header-addresses">
        <div class="address-item">
          <strong>Calicut - Malaparamba</strong>
          Kottayil Arcade, Malaparamba<br>
          Calicut-673009
        </div>
        <div class="address-item">
          <strong>Calicut - Kotooli</strong>
            Breeze Building, Netaji Nagar<br>
            Kotooli, Kozhikode-673016
        </div>
        <div class="address-item">
          <strong>Kochi - Kadavanthra</strong>
          RWA-N-16, Cherupushpam Lane 1<br>
          Kadavanthra, Kochi, 682020
        </div>
      </div>
    </div>

    <div style="text-align:center; margin-bottom: 10px;">
      <h2 style="font-size:18px; margin:0 0 6px;">Expense Details</h2>
      {% if expense.category %}<div class="small" style="color:#555;">Category: {{ expense.category.name }}</div>{% endif %}
    </div>

    <!-- Overview table (2-column) -->
    <table class="print-table">
      <tbody>
        <tr>
          <th style="width:22%;">Date</th>
          <td style="width:28%;">{{ expense.expense_date|date:"d-M-Y" }}</td>
          <th style="width:22%;">Amount</th>
          <td style="width:28%;">₹ {{ expense.amount|floatformat:2 }}</td>
        </tr>
        <tr>
          <th>Status</th>
          <td>
            {% if expense.status == 'pending' %}Pending
            {% elif expense.status == 'approved' %}Approved
            {% elif expense.status == 'paid' %}Paid
            {% elif expense.status == 'rejected' %}Rejected
            {% else %}{{ expense.get_status_display }}
            {% endif %}
          </td>
          <th>Submitted By</th>
          <td>{{ expense.requested_by|default:"—" }}</td>
        </tr>
        <tr>
          <th>Approved By</th>
          <td>{{ expense.approved_by|default:"—" }}</td>
          <th>Created</th>
          <td>{% if expense.created_at %}{{ expense.created_at|date:"d-M-Y h:i A" }}{% else %}—{% endif %}</td>
        </tr>
        <tr>
          <th>Updated</th>
          <td>{% if expense.updated_at %}{{ expense.updated_at|date:"d-M-Y h:i A" }}{% else %}—{% endif %}</td>
          <th>Attachment</th>
          <td>
            {% if expense.attachment %}
              {{ expense.attachment.name|default:expense.attachment.url }}
            {% else %}—
            {% endif %}
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Description -->
    <div class="section-title">Description</div>
    <div style="border:1px solid #ddd; padding:8px; min-height:48px;">
      {{ expense.description|linebreaksbr|default:"—" }}
    </div>

    <!-- Optional: show image preview when the attachment is an image -->
    {% if expense.attachment and expense.attachment.url|lower|slice:"-4:" in ".jpg.jpeg.png" %}
    <div class="section-title">Attachment Preview</div>
    <div style="border:1px solid #ddd; padding:8px;">
      <img src="{{ expense.attachment.url }}" alt="Attachment" style="max-width:100%; height:auto; border-radius:4px;">
    </div>
    {% endif %}

    <div class="print-footer">
      Generated by {{ request.user.get_full_name|default:request.user.username }} on {% now "F d, Y, h:i A" %}.
    </div>
  </div>

  <script>
    function printExpense(){ window.print(); }
  </script>
  {% endblock %}
