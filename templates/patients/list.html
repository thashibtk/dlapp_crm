{% extends 'base.html' %}
{% block content %}
<style>
  /* DataTables search placement */
  div.dataTables_wrapper div.dataTables_filter {
    position: static; top:auto; right:auto; flex: 1 1 auto;
    min-width: 200px; max-width: 300px; margin-left: auto; text-align: right;
  }
  @media (max-width: 767px) {
    div.dataTables_wrapper div.dataTables_filter {
      flex: 1 1 100%; min-width: unset; max-width: unset;
      margin-left: 0; text-align: left; order: -1; padding: 10px 0;
    }
  }
  .custom-scrollbar { max-height: 70vh; overflow: auto; }
</style>
<style>
  /* --- Print Styles - A4 Table List (same as Appointments) --- */
  .print-table-container { display: none; }

  @media print {
    @page { size: A4 portrait; margin: 10mm 8mm 15mm 8mm; }

    body {
      margin: 0 !important; padding: 0 !important;
      font-family: Arial, Helvetica, sans-serif !important;
      font-size: 10pt !important; line-height: 1.2 !important;
      color: #000 !important; background: #fff !important; width: 100% !important;
    }

    /* Hide everything by default */
    body * { visibility: hidden !important; }

    /* Show only the print container and its contents */
    .print-table-container, .print-table-container * { visibility: visible !important; }

    /* Place the print container at the top-left for clean layout */
    .print-table-container {
      display: block !important; position: absolute !important;
      left: 0 !important; top: 0 !important; width: 100% !important; margin: 0 !important; padding: 0 !important;
      background: #fff !important;
    }

    .print-header {
      display: flex !important; justify-content: space-between; align-items: flex-start;
      margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px;
    }
    .print-header-left { text-align: left; }
    .print-header-right { text-align: right; }
    .print-header img { width: 80px; height: auto; }

    .print-header h1 { font-size: 24px; font-weight: bold; color: #2b5f60; margin: 0; }
    .print-header p { margin: 5px 0; font-size: 12px; color: #555; }

    .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }

    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      color-adjust: exact !important;
    }

    .print-table th, .print-table td {
      border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 11px;
    }
    .print-table th { background-color: #2b5f60 !important; color: #fff !important; font-weight: bold; }
    .print-table tbody tr:nth-child(even) { background-color: #f9f9f9 !important; }

    .print-footer { text-align: center; margin-top: 50px; font-size: 10px; color: #666; }
  }
</style>



<div class="container-fluid default-dashboard">
  <div class="row">

    <!-- Header -->
    <div class="col-12 project-list">
      <div class="card">
          <div class="row align-items-center">
              <div class="col-6 p-0">
                  <ul class="nav nav-tabs border-tab d-flex" role="tablist">
                      <li class="nav-item">
                          <a class="nav-link active" href="#" role="tab" aria-selected="true">
                              <i class="fa fa-users me-2"></i>Patients
                          </a>
                      </li>
                      <li class="nav-item">
                          <span class="text-muted small">
                              <i class="fa fa-hashtag me-1"></i>Total: {{ patients|length }}
                          </span>
                      </li>
                  </ul>
              </div>
              <div class="col-6 p-0 d-flex justify-content-end align-items-center gap-2">
                  <a class="btn btn-primary" href="{% url 'patient_create' %}">
                      <i class="fa fa-plus-square me-2"></i>New Patient
                  </a>
              </div>
          </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="col-md-12">
      <form class="card p-3 mb-3 " method="get" id="filterForm">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label mb-1 small text-muted">
              <i class="fa fa-bolt me-1"></i>Quick range
            </label>
            <div class="btn-group w-100" role="group">
              <button class="btn btn-outline-secondary" type="button" data-range="today">
                <i class="fa fa-calendar-o me-1"></i>Today
              </button>
              <button class="btn btn-outline-secondary" type="button" data-range="7d">
                <i class="fa fa-calendar me-1"></i>Last 7 days
              </button>
              <button class="btn btn-outline-secondary" type="button" data-range="month">
                <i class="fa fa-calendar-check-o me-1"></i>This month
              </button>
            </div>
          </div>

          {# Keep ISO values for <input type="date"> #}
          <div class="col-12 col-md-2">
            <label class="form-label mb-1 small text-muted">
              <i class="fa fa-sign-in me-1"></i>From
            </label>
            <input type="date" class="form-control" name="from"
                   value="{{ selected.from|date:'Y-m-d' }}"
                   max="{{ selected.to|date:'Y-m-d' }}">
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label mb-1 small text-muted">
              <i class="fa fa-sign-out me-1"></i>To
            </label>
            <input type="date" class="form-control" name="to"
                   value="{{ selected.to|date:'Y-m-d' }}"
                   min="{{ selected.from|date:'Y-m-d' }}">
          </div>

          <div class="col-12 col-md-1">
            <label class="form-label mb-1 small text-muted">
              <i class="fa fa-money me-1"></i>Balance
            </label>
            <select class="form-select" name="balance_status">
              <option value="" {% if not selected.balance_status %}selected{% endif %}>All</option>
              <option value="due" {% if selected.balance_status == 'due' %}selected{% endif %}>Due</option>
              <option value="advance" {% if selected.balance_status == 'advance' %}selected{% endif %}>Advance</option>
              <option value="settled" {% if selected.balance_status == 'settled' %}selected{% endif %}>Settled</option>
            </select>
          </div>


          <div class="col-12 col-md-3 d-flex gap-2 justify-content-md-end">
            <button class="btn btn-outline-secondary flex-fill" type="submit">
              <i class="fa fa-filter me-2"></i>Filter
            </button>
            <a class="btn btn-light flex-fill" href="{% url 'patient_list' %}">
              <i class="fa fa-refresh me-2"></i>Clear
            </a>
            <button type="button" class="btn btn-outline-success flex-fill" onclick="printPatients()">
              <i class="fa fa-print me-2"></i>Print
            </button>

          </div>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="col-sm-12">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive custom-scrollbar">
            <table class="display table table-hover align-middle" id="basic-1">
              <thead>
                <tr>
                  <th><i class="fa fa-folder-open-o me-1"></i>File</th>
                  <th><i class="fa fa-user me-1"></i>Name</th>
                  <th><i class="fa fa-phone me-1"></i>Phone</th>
                  <th><i class="fa fa-money me-1"></i>Balance</th>
                  <th><i class="fa fa-building-o me-1"></i>City</th>
                  <th class="text-nowrap">
                    <i class="fa fa-calendar me-1"></i>Next Follow-up
                    <i class="fa fa-filter ms-1 text-muted nextfu-filter"
                       style="cursor:pointer;" title="Filtering: All"></i>
                  </th>
                  <th><i class="fa fa-clock-o me-1"></i>Registered</th>
                  <th><i class="fa fa-cog me-1"></i>Action</th>
                </tr>
              </thead>
              <tbody>
                {% now "U" as now_ts %}
                {% for p in patients %}
                {% with fu_ts=p.next_fu|date:"U" %}
                <tr>
                  <td class="font-monospace">{{ p.file_number }}</td>
                  <td>
                    <a class="text-decoration-none fw-semibold" href="{% url 'patient_detail' p.pk %}">
                      {{ p.name }}
                      <br>
                      <span class="small text-muted">
                        {% if p.age %}{{ p.age }} yrs{% else %}—{% endif %}
                      </span>
                    </a>
                  </td>
                  <td>{{ p.phone_number }}</td>
                  <td class="text-end">
                    {% if p.balance > 0 %}
                      <span class="text-danger">₹ {{ p.balance|floatformat:2 }}</span>
                    {% elif p.balance < 0 %} {# Negative balance means advance #}
                      <span class="text-success">₹ {{ p.balance|floatformat:2|slice:"1:" }}</span>
                    {% else %}
                      <span>₹ 0.00</span>
                    {% endif %}
                  </td>
                  <td>{{ p.city|default:"—" }}{% if p.district %} - {{ p.district }}{% endif %}</td>

                  <td class="text-nowrap nextfu-cell" data-order="{{ p.next_fu|date:'U'|default:0 }}">
                    {% if p.next_fu %}
                      {% if p.status == 'today' %}
                        <span class="badge bg-success">Today {{ p.next_fu|date:"d-M-Y" }}</span>
                      {% elif p.status == 'overdue' %}
                        <span class="badge bg-danger">Overdue {{ p.next_fu|date:"d-M-Y" }}</span>
                      {% elif p.status == 'tomorrow' %}
                        <span class="badge bg-warning text-dark">Tomorrow {{ p.next_fu|date:"d-M-Y" }}</span>
                      {% else %}
                        <span class="badge bg-info">{{ p.next_fu|date:"d-M-Y" }}</span>
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>

                  <td data-order="{{ p.created_at|date:'U' }}">
                    <span class="small text-muted">{{ p.created_at|date:"d-M-Y h:i A" }}</span>
                  </td>

                  <td>
                    <a class="btn btn-sm btn-outline-primary" href="{% url 'patient_detail' p.pk %}">
                      <i class="fa fa-eye me-1"></i>View
                    </a>
                  </td>
                </tr>
                {% endwith %}
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="small text-muted mt-2 d-flex align-items-center gap-3">
            <span><i class="fa fa-square text-success me-1"></i> Today</span>
            <span><i class="fa fa-square text-warning me-1"></i> Tomorrow</span>
            <span><i class="fa fa-square text-danger me-1"></i> Overdue</span>
            <span class="ms-auto d-none d-md-inline">
              <i class="fa fa-filter me-1"></i>
              Click the filter icon in “Next Follow-up” to toggle near-due rows.
            </span>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<div class="print-table-container">
  <div class="print-header">
    <div class="print-header-left">
      {% load static %}
      <img src="{% static 'assets/images/logo/dlapp_logo_grncut.png' %}" alt="DLapp">
    </div>
    <div class="print-header-right">
      <h1>D Lapp Hair Regenerative Clinic</h1>
      <p>
        Kottayil Arcade, Malaparamba,<br> Kozhikode, Kerala 673009<br>
        Phone: +91 8593957885 | Email: info@dlapphairclinic.com
      </p>
    </div>
  </div>

  <div style="text-align:center; margin-bottom:20px;">
    <h2 style="font-size:18px; margin-bottom:5px;">Patients List</h2>
    <p>
      Balance: <span id="printBalanceDisplay"></span> |
      Date Range: <span id="printDateRangeDisplay"></span> |
      Total: <strong>{{ patients|length }}</strong>
    </p>
  </div>

  <table class="print-table">
    <thead>
      <tr>
        <th style="width: 12%;">File #</th>
        <th style="width: 20%;">Name</th>
        <th style="width: 15%;">Phone</th>
        <th style="width: 12%;">Balance</th>
        <th style="width: 18%;">City</th>
        <th style="width: 23%;">Next Follow-up</th>
      </tr>
    </thead>
    <tbody>
      {% for p in patients %}
      <tr>
        <td>{{ p.file_number }}</td>
        <td>{{ p.name }}</td>
        <td>{{ p.phone_number|default:"—" }}</td>
        <td>
          {% if p.balance > 0 %}
            ₹ {{ p.balance|floatformat:2 }}
          {% elif p.balance < 0 %}
            ₹ {{ p.balance|floatformat:2|slice:"1:" }} (Advance)
          {% else %}
            ₹ 0.00
          {% endif %}
        </td>
        <td>
          {% if p.city %}{{ p.city }}{% else %}—{% endif %}{% if p.district %} - {{ p.district }}{% endif %}
        </td>
        <td>
          {% if p.next_fu %}
            {{ p.next_fu|date:"d-M-Y" }}
            {% if p.status == 'today' %}(Today){% elif p.status == 'tomorrow' %}(Tomorrow){% elif p.status == 'overdue' %}(Overdue){% endif %}
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="print-footer">
    Generated by {{ request.user.get_full_name|default:request.user.username }} on {% now "F d, Y, h:i A" %}.
  </div>
</div>


<script>
function printPatients() {
  const form = document.getElementById('filterForm');
  const balanceSel = form ? form.querySelector('select[name="balance_status"]') : null;
  const fromDate = form ? (form.querySelector('input[name="from"]')?.value || '') : '';
  const toDate   = form ? (form.querySelector('input[name="to"]')?.value || '') : '';

  // Balance filter label
  if (balanceSel) {
    const label = balanceSel.value
      ? balanceSel.options[balanceSel.selectedIndex].text
      : 'All';
    document.getElementById('printBalanceDisplay').textContent = label;
  } else {
    document.getElementById('printBalanceDisplay').textContent = 'All';
  }

  // Date range label
  let dateRange = 'All Dates';
  if (fromDate && toDate) {
    dateRange = `From ${fromDate} to ${toDate}`;
  } else if (fromDate) {
    dateRange = `From ${fromDate}`;
  } else if (toDate) {
    dateRange = `To ${toDate}`;
  }
  document.getElementById('printDateRangeDisplay').textContent = dateRange;

  window.print();
}
</script>

<!-- Quick range + near-followup filter + DataTables -->
<script>
(function () {
  // ---------- Filter (quick range + manual dates) ----------
  const form = document.getElementById('filterForm');
  if (form) {
    const from = form.querySelector('input[name="from"]');
    const to   = form.querySelector('input[name="to"]');
    const buttons = form.querySelectorAll('[data-range]');

    const pad = n => String(n).padStart(2, '0');
    const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseISO = s => {
      if (!s) return null;
      const [y, m, d] = s.split('-').map(Number);
      return new Date(y, m - 1, d);
    };

    // Date helpers (all in local time to match <input type="date">)
    const today = (() => { const n = new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()); })();
    const start7d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6);
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const monthEnd   = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    const setMinMax = () => {
      if (!from || !to) return;
      to.min = from.value || '';
      from.max = to.value || '';
    };

    const clearActive = () => {
      buttons.forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      });
    };

    const setActive = (btn) => {
      clearActive();
      if (btn) {
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');
      }
    };

    // Compute & apply a quick range
    function applyRange(kind) {
      let start = new Date(today), end = new Date(today);
      if (kind === '7d') {
        start = start7d;
      } else if (kind === 'month') {
        start = monthStart;
        end = monthEnd;
      } else if (kind === 'today') {
        // start/end already today
      }
      if (from) from.value = toISO(start);
      if (to)   to.value   = toISO(end);
      setMinMax();
    }

    // Infer active quick-range from current inputs (run on load)
    function inferActiveFromInputs() {
      const f = parseISO(from?.value);
      const t = parseISO(to?.value);
      if (!f || !t) { clearActive(); return; }

      const fISO = toISO(f), tISO = toISO(t);
      if (fISO === toISO(today) && tISO === toISO(today)) {
        setActive(form.querySelector('[data-range="today"]')); return;
      }
      if (fISO === toISO(start7d) && tISO === toISO(today)) {
        setActive(form.querySelector('[data-range="7d"]')); return;
      }
      if (fISO === toISO(monthStart) && tISO === toISO(monthEnd)) {
        setActive(form.querySelector('[data-range="month"]')); return;
      }
      clearActive();
    }

    // Init active state on load
    inferActiveFromInputs();
    setMinMax();

    // Quick-range clicks
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const kind = btn.getAttribute('data-range');
        applyRange(kind);
        setActive(btn);
        form.submit();
      });
    });

    // Manual date edits: clear active state, keep min/max synced (no auto-submit)
    const onDateChange = () => {
      // If user sets an inverted range, nudge 'to' forward
      if (from?.value && to?.value && to.value < from.value) {
        to.value = from.value;
      }
      setMinMax();
      clearActive();
    };
    from?.addEventListener('input', onDateChange);
    to?.addEventListener('input', onDateChange);
  }

  // ---------- DataTables (if included) ----------
  if (window.jQuery && jQuery.fn.DataTable) {
    jQuery('#basic-1').DataTable({
      pageLength: 25,
      order: [[5, 'asc']],                 // Next Follow-up column
      columnDefs: [{ orderable: false, targets: [7] }] // Action column
    });
  }

  // ---------- Near follow-up filter ----------
  const icon = document.querySelector('.nextfu-filter');
  const rows = document.querySelectorAll('#basic-1 tbody tr');
  if (icon) {
    let mode = 'all';
    const applyFilter = () => {
      rows.forEach(row => {
        const cell = row.querySelector('.nextfu-cell');
        if (!cell) return;
        const txt = cell.textContent.trim();
        const isNear = /(Today|Tomorrow|Overdue)/i.test(txt);
        row.style.display = (mode === 'near') ? (isNear ? '' : 'none') : '';
      });
    };
    icon.addEventListener('click', () => {
      mode = (mode === 'all') ? 'near' : 'all';
      icon.classList.toggle('text-muted', mode === 'all');
      icon.classList.toggle('text-success', mode === 'near');
      icon.title = (mode === 'near') ? 'Filtering: Near Due' : 'Filtering: All';
      applyFilter();
    });
  }
})();
</script>

{% endblock %}
